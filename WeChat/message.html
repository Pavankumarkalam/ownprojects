<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeChat - Messages</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-container {
            min-height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .chat-sidebar {
            width: 320px;
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--bg-primary);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .user-info:hover {
            background: var(--bg-tertiary);
        }
        
        .logout-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
            border: none;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #ff4757;
            color: white;
            opacity: 1;
            transform: scale(1.05);
        }
        
        .sidebar-actions {
            display: flex;
            gap: 15px;
        }
        
        .sidebar-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-action:hover {
            background: var(--bg-tertiary);
        }
        
        /* Dropdown Menu Styles */
        .dropdown-menu {
            position: absolute;
            top: 70px;
            right: 15px;
            width: 220px;
            background: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            font-size: 14px;
            border-bottom: 1px solid transparent;
        }
        
        .menu-item:hover {
            background: var(--bg-secondary);
            color: var(--primary-color);
        }
        
        .menu-item i {
            width: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .menu-item:hover i {
            color: var(--primary-color);
        }
        
        .menu-divider {
            height: 1px;
            background: var(--bg-tertiary);
            margin: 4px 0;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .search-box {
            padding: 15px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 20px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 0 70px;
        }
        
        .chat-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .chat-item:hover, .chat-item.active {
            background: var(--bg-secondary);
        }
        
        .chat-item.active {
            border-left: 3px solid var(--primary-color);
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
        }
        
        .chat-details {
            flex: 1;
            min-width: 0;
        }
        
        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .chat-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-name.group-chat {
            display: flex;
            align-items: center;
        }
        
        .chat-name.group-chat:before {
            content: "\f0c0";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            font-size: 0.8em;
            margin-right: 5px;
            color: var(--primary-color);
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .chat-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .unread-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-color);
            border: 2px solid var(--bg-secondary);
        }
        
        .main-chat {
            margin-left: 320px;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notification-toggle {
            margin-left: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: color 0.3s;
        }
        
        .notification-toggle.active {
            color: var(--primary-color);
        }
        
        .chat-with {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-with-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .chat-with-info {
            display: flex;
            flex-direction: column;
        }
        
        .chat-with-name {
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .chat-with-name:hover {
            background: var(--bg-tertiary);
            color: var(--primary-color);
        }
        
        .chat-with-status {
            font-size: 0.75rem;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .chat-actions {
            display: flex;
            gap: 15px;
        }
        
        .chat-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-action:hover {
            background: var(--bg-tertiary);
        }
        
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        .message-received {
            background: var(--bg-secondary);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .message-sent {
            background: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            font-size: 0.7rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }
        
        .message-status {
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            animation: pulse 1.5s infinite;
        }
        
        .message-options {
            position: absolute;
            top: 5px;
            right: 5px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .message:hover .message-options {
            visibility: visible;
            opacity: 1;
        }
        
        .message-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            margin-left: 5px;
        }
        
        .message-sent .message-option {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .message-received .message-option {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-muted);
        }
        
        .message-option:hover {
            transform: scale(1.1);
        }
        
        .message-option.delete:hover {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .message-option.reply:hover {
            background: rgba(0, 122, 255, 0.2);
            color: #007aff;
        }
        
        .message-context-menu {
            position: absolute;
            width: 150px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }
        
        .menu-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .menu-option:hover {
            background: var(--bg-secondary);
        }
        
        .menu-option.delete {
            color: #ff3b30;
        }
        
        .menu-option.reply {
            color: #007aff;
        }
        
        .reply-container {
            padding: 10px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--primary-color);
            border-radius: 6px;
            margin-bottom: 8px;
            max-width: 90%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        .reply-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .reply-user {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }
        
        .cancel-reply {
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .cancel-reply:hover {
            color: var(--text-primary);
        }
        
        .message-with-reply {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        
        .reply-reference {
            font-size: 0.8rem;
            color: var(--primary-color);
            padding: 5px 10px;
            background: rgba(0, 123, 255, 0.05);
            border-left: 3px solid var(--primary-color);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            margin-bottom: -5px;
            cursor: pointer;
        }
        
        .message-received .reply-reference {
            background: rgba(0, 0, 0, 0.03);
        }
        
        .message-sent .reply-reference {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-primary);
        }
        
        .input-actions {
            display: flex;
            gap: 10px;
        }
        
        .input-action {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .input-action:hover {
            background: var(--bg-tertiary);
        }
        
        .message-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 15px;
            max-height: 100px;
            overflow-y: auto;
            margin-top: 8px;
            border-radius: 10px;
            background: var(--bg-secondary);
        }
        
        .selected-file {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 15px;
            background: var(--bg-tertiary);
            font-size: 0.8rem;
            color: var(--text-primary);
        }
        
        .selected-file .file-icon {
            color: var(--primary-color);
        }
        
        .selected-file .file-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .selected-file .remove-file {
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px;
            margin-left: 3px;
        }
        
        .selected-file .remove-file:hover {
            color: var(--danger-color);
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 50px;
            left: 0;
            width: 300px;
            height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .emoji-picker-header {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .emoji-category {
            display: flex;
            gap: 5px;
        }
        
        .emoji-category-btn {
            padding: 5px;
            border-radius: 5px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .emoji-category-btn:hover,
        .emoji-category-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .emoji-search {
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 15px;
            color: var(--text-primary);
            outline: none;
            width: 100%;
            margin: 5px 0;
        }
        
        .emoji-content {
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            overflow-y: auto;
            flex: 1;
        }
        
        .emoji {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .emoji:hover {
            background: var(--bg-tertiary);
        }
        
        .file-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        .file-message {
            background: var(--bg-tertiary) !important;
            padding: 10px 15px !important;
        }
        
        .file-link {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary-color);
            text-decoration: none;
            padding: 5px 0;
        }
        
        .file-link i {
            font-size: 1.2rem;
        }
        
        .send-button {
            width: 50px;
            height: 40px;
            border-radius: 20px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .send-button:hover {
            background: var(--primary-hover);
        }
        
        .date-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .date-divider::before, .date-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
            margin: 0 10px;
        }
        
        .loading-messages {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            position: relative;
        }
        
        .loading-messages::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: var(--text-secondary);
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 5px 15px;
            animation: fadeIn 0.3s ease;
        }
        
        .typing-dots {
            display: flex;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-secondary);
            margin: 0 1px;
            animation: typingDot 1.3s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }
        
        /* Call Interface Styles */
        .call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px 20px;
            color: white;
            animation: fadeIn 0.3s ease;
        }
        
        .call-header {
            text-align: center;
            padding: 20px;
        }
        
        .call-title {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .call-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .call-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .call-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255, 255, 255, 0.3);
            margin: 20px 0;
        }
        
        .call-actions {
            display: flex;
            gap: 20px;
        }
        
        .call-action {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .call-action.end-call {
            background-color: #ff3b30;
        }
        
        .call-action.end-call:hover {
            background-color: #ff1a0c;
        }
        
        .call-action.accept-call {
            background-color: #34c759;
        }
        
        .call-action.accept-call:hover {
            background-color: #2baa4a;
        }
        
        .call-action.toggle-mic, .call-action.toggle-camera {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .call-action.toggle-mic:hover, .call-action.toggle-camera:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .call-action.disabled {
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 60vh;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .self-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 200px;
            border-radius: 10px;
            background: #333;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .self-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .call-status-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        
        .call-status-icon i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(0.95);
                opacity: 0.8;
            }
        }
        
        @keyframes highlight {
            0% { background-color: rgba(0, 123, 255, 0.4); }
            50% { background-color: rgba(0, 123, 255, 0.2); }
            100% { background-color: transparent; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(30px); }
        }
        
        /* Mobile View Responsive Design */
        /* Group Chat Styles */
        .group-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .group-modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .group-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .group-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .group-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .group-modal-body {
            padding: 20px;
        }
        
        .group-form-field {
            margin-bottom: 15px;
        }
        
        .group-form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .group-form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .group-form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .group-members {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: var(--bg-secondary);
        }
        
        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .member-name {
            flex: 1;
            font-weight: 500;
        }
        
        .member-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .member-remove:hover {
            color: #ff3b30;
        }
        
        .add-members {
            margin-top: 15px;
        }
        
        .contact-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .add-member-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .group-form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .group-form-btn {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        
        .group-form-btn.cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: 10px;
        }
        
        .group-form-btn.create {
            background: var(--primary-color);
            color: white;
        }
        
        .group-info-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .group-info-btn:hover {
            background: var(--bg-tertiary);
        }
        
        .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .group-member {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            text-align: center;
        }
        
        .group-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
        }
        
        .group-member-name {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* Media Queries */
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .chat-sidebar.active {
                transform: translateX(0);
            }
            
            .main-chat {
                margin-left: 0;
            }
            
            .mobile-nav {
                display: block;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--bg-primary);
                border-top: 1px solid var(--border-color);
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 100;
            }
            
            .mobile-nav-item {
                flex: 1;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-size: 0.7rem;
                cursor: pointer;
            }
            
            .mobile-nav-item i {
                font-size: 1.2rem;
                margin-bottom: 3px;
            }
            
            .mobile-nav-item.active {
                color: var(--primary-color);
            }
        }
        
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar for Chat List -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-info">
                        <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face" alt="Profile" class="user-avatar">
                        <div class="user-name" id="current-user">Kalam Pavan</div>
                    </div>
                    <button class="logout-btn" id="logout-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                <div class="sidebar-actions">
                    <div class="sidebar-action" id="create-group-btn" title="Create Group">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="sidebar-action">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="sidebar-action" id="menu-btn" title="Menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </div>
                
                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="user-menu">
                    <div class="menu-item" id="settings-menu">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                    <div class="menu-item" id="theme-menu">
                        <i class="fas fa-palette"></i>
                        <span>Theme</span>
                    </div>
                    <div class="menu-item" id="notifications-menu">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </div>
                    <div class="menu-item" id="privacy-menu">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy</span>
                    </div>
                    <div class="menu-item" id="help-menu">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item" id="about-menu">
                        <i class="fas fa-info-circle"></i>
                        <span>About WeChat</span>
                    </div>
                </div>
            </div>
            <div class="search-box">
                <input type="text" placeholder="Search chats" class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="chat-list" id="chat-list">
                <!-- Chat item with Ogety Karthik - this will be active -->
                <div class="chat-item active" data-user="Ogety Karthik" data-handle="@O_Karthik" data-avatar="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face" data-status="offline">
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Ogety Karthik</div>
                            <div class="chat-time">Just now</div>
                        </div>
                        <div class="chat-message" id="last-message-preview">...</div>
                    </div>
                </div>
                
                <!-- Other example chat items -->
                <div class="chat-item" data-user="Suman" data-handle="@suman" data-avatar="https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=150&h=150&fit=crop&crop=face" data-status="online">
                    <img src="https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="online-indicator"></div>
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Suman</div>
                            <div class="chat-time">12:30 PM</div>
                        </div>
                        <div class="chat-message">Hey, are you coming to the meeting?</div>
                    </div>
                    <span class="unread-badge">2</span>
                </div>
                
                <div class="chat-item" data-user="Vamsi" data-handle="@vamsi" data-avatar="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&h=150&fit=crop&crop=face" data-status="online">
                    <img src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="online-indicator"></div>
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Vamsi</div>
                            <div class="chat-time">Yesterday</div>
                        </div>
                        <div class="chat-message">Thanks for helping with the project!</div>
                    </div>
                </div>
                
                <div class="chat-item" data-user="Badri" data-handle="@badri" data-avatar="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face" data-status="offline">
                    <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Badri</div>
                            <div class="chat-time">Wed</div>
                        </div>
                        <div class="chat-message">Did you finish the report?</div>
                    </div>
                </div>
                
                <div class="chat-item" data-user="Sai" data-handle="@sai" data-avatar="https://images.unsplash.com/photo-1566492031773-4f4e44671d66?w=150&h=150&fit=crop&crop=face" data-status="online">
                    <img src="https://images.unsplash.com/photo-1566492031773-4f4e44671d66?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="online-indicator"></div>
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Sai</div>
                            <div class="chat-time">Tue</div>
                        </div>
                        <div class="chat-message">Let's catch up this weekend!</div>
                    </div>
                </div>
                
                <!-- Harsha Chat Item -->
                <div class="chat-item" data-user="Harsha" data-handle="@harsha" data-avatar="https://images.unsplash.com/photo-1560250097-0b93528c311a?w=150&h=150&fit=crop&crop=face" data-status="online">
                    <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="online-indicator"></div>
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Harsha</div>
                            <div class="chat-time">Today</div>
                        </div>
                        <div class="chat-message">Hi, can we discuss the project?</div>
                    </div>
                </div>
                
                <!-- Anushka Chat Item -->
                <div class="chat-item" data-user="Anushka" data-handle="@anushka" data-avatar="https://images.unsplash.com/photo-1494790108755-2616b612b4ab?w=150&h=150&fit=crop&crop=face" data-status="online">
                    <img src="https://images.unsplash.com/photo-1494790108755-2616b612b4ab?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-avatar">
                    <div class="online-indicator"></div>
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">Anushka</div>
                            <div class="chat-time">Today</div>
                        </div>
                        <div class="chat-message">Hi there! How is your project going?</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-with">
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face" alt="Avatar" class="chat-with-avatar" id="chat-with-avatar">
                    <div class="chat-with-info">
                        <div class="chat-with-name" id="chat-with-name">Ogety Karthik</div>
                        <div class="chat-with-status" id="chat-with-status">
                            <span class="status-indicator"></span>
                            Offline - Last seen 2h ago
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <div class="chat-action" id="audio-call-btn">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="chat-action" id="video-call-btn">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="chat-action notification-toggle active" id="notification-toggle">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="chat-action" id="chat-info-btn">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="chat-action" id="group-info-btn" style="display: none;">
                        <i class="fas fa-users-cog"></i>
                    </div>
                </div>
            </div>
            
            <div class="messages-area" id="messages-area">
                <div class="date-divider">Today</div>
                
                <!-- Messages will be dynamically inserted here by JavaScript -->
            </div>
            
            <div class="chat-input-area">
                <div class="input-actions">
                    <div class="input-action" id="emoji-picker-btn">
                        <i class="fas fa-smile"></i>
                    </div>
                    <div class="input-action" id="attachment-btn">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" id="file-input" style="display: none;" multiple>
                    </div>
                </div>
                <div class="message-input-wrapper">
                    <textarea class="message-input" placeholder="Type a message..." id="message-input"></textarea>
                    <div id="selected-files" class="selected-files"></div>
                    <div id="emoji-picker" class="emoji-picker"></div>
                </div>
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Database simulation using localStorage
        class ChatDatabase {
            constructor() {
                this.initialize();
            }
            
            initialize() {
                // Check if we already have data in localStorage
                if (!localStorage.getItem('wechat_users')) {
                    // Set up initial users
                    const users = [
                        {
                            id: 1,
                            name: 'Kalam Pavan',
                            handle: '@kp',
                            avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face',
                            status: 'online'
                        },
                        {
                            id: 2,
                            name: 'Ogety Karthik',
                            handle: '@O_Karthik',
                            avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                            status: 'offline',
                            lastSeen: '2h ago'
                        },
                        {
                            id: 3,
                            name: 'Suman',
                            handle: '@suman',
                            avatar: 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=150&h=150&fit=crop&crop=face',
                            status: 'online'
                        },
                        {
                            id: 4,
                            name: 'Vamsi',
                            handle: '@vamsi',
                            avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&h=150&fit=crop&crop=face',
                            status: 'online'
                        },
                        {
                            id: 5,
                            name: 'Badri',
                            handle: '@badri',
                            avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face',
                            status: 'offline',
                            lastSeen: '5h ago'
                        },
                        {
                            id: 6,
                            name: 'Sai',
                            handle: '@sai',
                            avatar: 'https://images.unsplash.com/photo-1566492031773-4f4e44671d66?w=150&h=150&fit=crop&crop=face',
                            status: 'online'
                        },
                        {
                            id: 7,
                            name: 'Harsha',
                            handle: '@harsha',
                            avatar: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=150&h=150&fit=crop&crop=face',
                            status: 'online'
                        }
                    ];
                    
                    localStorage.setItem('wechat_users', JSON.stringify(users));
                    
                    // Set up initial conversations
                    const conversations = {
                        // Conversation between Kalam Pavan (1) and Ogety Karthik (2)
                        '1_2': {
                            participants: [1, 2],
                            messages: [
                                {
                                    id: Date.now() - 86400000,
                                    senderId: 2,
                                    text: 'Hi Pavan, good morning!',
                                    timestamp: new Date(Date.now() - 86400000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 86000000,
                                    senderId: 1,
                                    text: 'Good morning Karthik! How are you doing?',
                                    timestamp: new Date(Date.now() - 86000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 85000000,
                                    senderId: 2,
                                    text: 'I\'m doing well. Do you have time to discuss the project today?',
                                    timestamp: new Date(Date.now() - 85000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 84000000,
                                    senderId: 1,
                                    text: 'Sure, I\'m free after 2 PM. Does that work for you?',
                                    timestamp: new Date(Date.now() - 84000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 83000000,
                                    senderId: 2,
                                    text: 'Perfect! Let\'s meet at 3 PM in the conference room.',
                                    timestamp: new Date(Date.now() - 83000000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        },
                        // Conversation between Kalam Pavan (1) and Suman (3)
                        '1_3': {
                            participants: [1, 3],
                            messages: [
                                {
                                    id: Date.now() - 172800000,
                                    senderId: 3,
                                    text: 'Hey Pavan! Would you like to grab coffee tomorrow?',
                                    timestamp: new Date(Date.now() - 172800000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 172000000,
                                    senderId: 1,
                                    text: 'That sounds great Suman! What time were you thinking?',
                                    timestamp: new Date(Date.now() - 172000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 171000000,
                                    senderId: 3,
                                    text: 'How about 10 AM at the new café downtown?',
                                    timestamp: new Date(Date.now() - 171000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 170000000,
                                    senderId: 1,
                                    text: 'Perfect, I\'ll see you there!',
                                    timestamp: new Date(Date.now() - 170000000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        },
                        // Conversation between Kalam Pavan (1) and Vamsi (4)
                        '1_4': {
                            participants: [1, 4],
                            messages: [
                                {
                                    id: Date.now() - 259200000,
                                    senderId: 4,
                                    text: 'Hi Pavan, can you help me review the presentation?',
                                    timestamp: new Date(Date.now() - 259200000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 258000000,
                                    senderId: 1,
                                    text: 'Of course Vamsi! When do you need it by?',
                                    timestamp: new Date(Date.now() - 258000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 257000000,
                                    senderId: 4,
                                    text: 'If possible by tomorrow? I have to present on Friday.',
                                    timestamp: new Date(Date.now() - 257000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 256000000,
                                    senderId: 1,
                                    text: 'No problem, I\'ll look at it tonight and send you feedback.',
                                    timestamp: new Date(Date.now() - 256000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 255000000,
                                    senderId: 4,
                                    text: 'Thanks a lot! I appreciate it.',
                                    timestamp: new Date(Date.now() - 255000000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        },
                        // Conversation between Kalam Pavan (1) and Harsha (5)
                        '1_5': {
                            participants: [1, 5],
                            messages: [
                                {
                                    id: Date.now() - 345600000,
                                    senderId: 5,
                                    text: 'Hello Pavan, I have some ideas for the project that I\'d like to share.',
                                    timestamp: new Date(Date.now() - 345600000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 344000000,
                                    senderId: 1,
                                    text: 'Hi Harsha! I\'d love to hear them. Do you want to schedule a meeting?',
                                    timestamp: new Date(Date.now() - 344000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 343000000,
                                    senderId: 5,
                                    text: 'Yes, let\'s meet tomorrow at 2 PM if you\'re free.',
                                    timestamp: new Date(Date.now() - 343000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 342000000,
                                    senderId: 1,
                                    text: 'That works for me. I\'ll book the meeting room.',
                                    timestamp: new Date(Date.now() - 342000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 340000000,
                                    senderId: 5,
                                    text: 'Great! I\'ll prepare the mockups to show you.',
                                    timestamp: new Date(Date.now() - 340000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 339000000,
                                    senderId: 1,
                                    text: 'Perfect, looking forward to seeing them!',
                                    timestamp: new Date(Date.now() - 339000000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        },
                        // Conversation between Kalam Pavan (1) and Ravi (6)
                        '1_6': {
                            participants: [1, 6],
                            messages: [
                                {
                                    id: Date.now() - 432000000,
                                    senderId: 6,
                                    text: 'Hi Pavan, did you get a chance to look at the documentation I sent?',
                                    timestamp: new Date(Date.now() - 432000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 431000000,
                                    senderId: 1,
                                    text: 'Hi Ravi! Yes, I reviewed it yesterday. It looks comprehensive.',
                                    timestamp: new Date(Date.now() - 431000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 430000000,
                                    senderId: 6,
                                    text: 'Great! Do you have any feedback or suggestions?',
                                    timestamp: new Date(Date.now() - 430000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 429000000,
                                    senderId: 1,
                                    text: 'I think it covers everything well. Maybe add a section on troubleshooting common issues?',
                                    timestamp: new Date(Date.now() - 429000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 428000000,
                                    senderId: 6,
                                    text: 'That\'s a good suggestion. I\'ll work on that and send you an updated version.',
                                    timestamp: new Date(Date.now() - 428000000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        },
                        // Conversation between Kalam Pavan (1) and Harsha (7)
                        '1_7': {
                            participants: [1, 7],
                            messages: [
                                {
                                    id: Date.now() - 1800000,
                                    senderId: 7,
                                    text: 'Hi, can we discuss the project?',
                                    timestamp: new Date(Date.now() - 1800000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        }
                    };
                    
                    localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                    
                    // Set up initial groups
                    const groups = [
                        {
                            id: 'g1',
                            name: 'Project Team',
                            avatar: 'https://ui-avatars.com/api/?background=0D8ABC&color=fff&name=PT',
                            members: [1, 2, 3, 5],
                            createdBy: 1,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    localStorage.setItem('wechat_groups', JSON.stringify(groups));
                    
                    // Set up initial group conversations
                    const groupConversations = {
                        'g1': {
                            messages: [
                                {
                                    id: Date.now() - 3600000,
                                    senderId: 2,
                                    text: 'Hello team!',
                                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 3000000,
                                    senderId: 1,
                                    text: 'Hi everyone! How\'s the project going?',
                                    timestamp: new Date(Date.now() - 3000000).toISOString(),
                                    status: 'read'
                                },
                                {
                                    id: Date.now() - 2400000,
                                    senderId: 5,
                                    text: 'We\'re on track for the deadline.',
                                    timestamp: new Date(Date.now() - 2400000).toISOString(),
                                    status: 'read'
                                }
                            ]
                        }
                    };
                    
                    localStorage.setItem('wechat_group_conversations', JSON.stringify(groupConversations));
                }
            }
            
            getCurrentUser() {
                return {
                    id: 1,
                    name: 'Kalam Pavan',
                    handle: '@kp'
                };
            }
            
            getUserById(id) {
                const users = JSON.parse(localStorage.getItem('wechat_users'));
                return users.find(user => user.id === id);
            }
            
            getUserByName(name) {
                const users = JSON.parse(localStorage.getItem('wechat_users'));
                return users.find(user => user.name === name);
            }
            
            updateUserStatus(userId, isOnline) {
                const users = JSON.parse(localStorage.getItem('wechat_users'));
                const userIndex = users.findIndex(user => user.id === userId);
                
                if (userIndex !== -1) {
                    const now = Date.now();
                    
                    if (isOnline) {
                        users[userIndex].status = 'online';
                        users[userIndex].lastActivity = now;
                    } else {
                        users[userIndex].status = 'offline';
                        users[userIndex].lastSeen = new Date().toISOString();
                    }
                    localStorage.setItem('wechat_users', JSON.stringify(users));
                }
                
                return users[userIndex];
            }
            
            updateUserActivity(userId) {
                const users = JSON.parse(localStorage.getItem('wechat_users'));
                const userIndex = users.findIndex(user => user.id === userId);
                
                if (userIndex !== -1) {
                    users[userIndex].lastActivity = Date.now();
                    users[userIndex].status = 'online';
                    localStorage.setItem('wechat_users', JSON.stringify(users));
                }
                
                return users[userIndex];
            }
            
            // Function to add a new contact/friend
            addUser(name, handle, avatar, status = 'offline') {
                const users = JSON.parse(localStorage.getItem('wechat_users'));
                
                // Generate a new ID (highest existing ID + 1)
                const newId = Math.max(...users.map(user => user.id)) + 1;
                
                const newUser = {
                    id: newId,
                    name: name,
                    handle: handle || `@${name.toLowerCase().replace(/\s/g, '_')}`,
                    avatar: avatar || ``,
                    status: status
                };
                
                // Add to users array
                users.push(newUser);
                localStorage.setItem('wechat_users', JSON.stringify(users));
                
                // Create an empty conversation with the current user
                const currentUser = this.getCurrentUser();
                const conversationKey = `${currentUser.id}_${newId}`;
                
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                conversations[conversationKey] = {
                    participants: [currentUser.id, newId],
                    messages: []
                };
                
                localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                
                return newUser;
            }
            
            getLastSeen(userId) {
                const user = this.getUserById(userId);
                if (!user || user.status === 'online') return null;
                
                const lastSeen = user.lastSeen;
                if (!lastSeen) return 'a while ago';
                
                return this.formatLastSeen(new Date(lastSeen));
            }
            
            formatLastSeen(lastSeenDate) {
                const now = new Date();
                const diffMs = now - lastSeenDate;
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffSecs < 60) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays === 1) return 'yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                
                return lastSeenDate.toLocaleDateString();
            }
            
            getConversation(user1Id, user2Id) {
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                const conversationKey = this.getConversationKey(user1Id, user2Id);
                return conversations[conversationKey] || { messages: [] };
            }
            
            getConversationKey(user1Id, user2Id) {
                // Create a consistent key regardless of the order of IDs
                return user1Id < user2Id ? `${user1Id}_${user2Id}` : `${user2Id}_${user1Id}`;
            }
            
            sendMessage(senderId, receiverId, text) {
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                const conversationKey = this.getConversationKey(senderId, receiverId);
                
                // Create conversation if it doesn't exist
                if (!conversations[conversationKey]) {
                    conversations[conversationKey] = {
                        participants: [senderId, receiverId],
                        messages: []
                    };
                }
                
                // Add new message with current time in IST
                const message = {
                    id: Date.now(),
                    senderId,
                    text,
                    timestamp: new Date().toISOString(), // Store in ISO format for consistency
                    status: 'sent', // can be 'sent', 'delivered', 'read'
                    istTime: true // Flag indicating we're using IST time
                };
                
                conversations[conversationKey].messages.push(message);
                localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                
                console.log(`Message saved: ${text} from ${senderId} to ${receiverId}`);
                console.log('Conversation key:', conversationKey);
                console.log('Total messages in conversation:', conversations[conversationKey].messages.length);
                
                return message;
            }
            
            getAllConversationsForUser(userId) {
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations'));
                const userConversations = {};
                
                for (const [key, conversation] of Object.entries(conversations)) {
                    if (conversation.participants.includes(userId)) {
                        userConversations[key] = conversation;
                    }
                }
                
                return userConversations;
            }
            
            // Group Methods
            getAllGroups() {
                return JSON.parse(localStorage.getItem('wechat_groups')) || [];
            }
            
            getGroupsForUser(userId) {
                const groups = this.getAllGroups();
                return groups.filter(group => group.members.includes(userId));
            }
            
            getGroupById(groupId) {
                const groups = this.getAllGroups();
                return groups.find(group => group.id === groupId);
            }
            
            createGroup(name, members, createdBy) {
                const groups = this.getAllGroups();
                const newGroupId = 'g' + Date.now();
                
                const newGroup = {
                    id: newGroupId,
                    name: name,
                    avatar: `https://ui-avatars.com/api/?background=0D8ABC&color=fff&name=${encodeURIComponent(name.substring(0, 2))}`,
                    members: members,
                    createdBy: createdBy,
                    createdAt: new Date().toISOString()
                };
                
                groups.push(newGroup);
                localStorage.setItem('wechat_groups', JSON.stringify(groups));
                
                // Create empty conversation for this group
                const groupConversations = JSON.parse(localStorage.getItem('wechat_group_conversations')) || {};
                groupConversations[newGroupId] = { messages: [] };
                localStorage.setItem('wechat_group_conversations', JSON.stringify(groupConversations));
                
                return newGroup;
            }
            
            addMemberToGroup(groupId, userId) {
                const groups = this.getAllGroups();
                const group = groups.find(g => g.id === groupId);
                
                if (group && !group.members.includes(userId)) {
                    group.members.push(userId);
                    localStorage.setItem('wechat_groups', JSON.stringify(groups));
                    return true;
                }
                
                return false;
            }
            
            removeMemberFromGroup(groupId, userId) {
                const groups = this.getAllGroups();
                const group = groups.find(g => g.id === groupId);
                
                if (group) {
                    group.members = group.members.filter(id => id !== userId);
                    localStorage.setItem('wechat_groups', JSON.stringify(groups));
                    return true;
                }
                
                return false;
            }
            
            getGroupConversation(groupId) {
                const groupConversations = JSON.parse(localStorage.getItem('wechat_group_conversations')) || {};
                return groupConversations[groupId] || { messages: [] };
            }
            
            sendGroupMessage(groupId, senderId, text) {
                const groupConversations = JSON.parse(localStorage.getItem('wechat_group_conversations')) || {};
                
                if (!groupConversations[groupId]) {
                    groupConversations[groupId] = { messages: [] };
                }
                
                const message = {
                    id: Date.now(),
                    senderId: senderId,
                    text: text,
                    timestamp: new Date().toISOString(),
                    status: 'sent',
                    istTime: true // Flag indicating we're using IST time
                };
                
                groupConversations[groupId].messages.push(message);
                localStorage.setItem('wechat_group_conversations', JSON.stringify(groupConversations));
                
                return message;
            }
            
            deleteGroup(groupId) {
                const groups = this.getAllGroups();
                const updatedGroups = groups.filter(group => group.id !== groupId);
                localStorage.setItem('wechat_groups', JSON.stringify(updatedGroups));
                
                // Also delete the group conversation
                const groupConversations = JSON.parse(localStorage.getItem('wechat_group_conversations')) || {};
                delete groupConversations[groupId];
                localStorage.setItem('wechat_group_conversations', JSON.stringify(groupConversations));
                
                return true;
            }
            
            renameGroup(groupId, newName) {
                const groups = this.getAllGroups();
                const group = groups.find(g => g.id === groupId);
                
                if (group) {
                    group.name = newName;
                    localStorage.setItem('wechat_groups', JSON.stringify(groups));
                    return true;
                }
                
                return false;
            }
        }
        
        // Chat UI Controller
        class ChatUI {
            constructor() {
                this.db = new ChatDatabase();
                this.currentUser = this.db.getCurrentUser();
                
                // Set current user as online
                this.db.updateUserStatus(this.currentUser.id, true);
                
                // Get friend name from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const friendName = urlParams.get('friend') || 'Ogety Karthik'; // Default to Ogety Karthik if no parameter
                const groupId = urlParams.get('group');
                
                if (groupId) {
                    // We're opening a group chat
                    this.activeChat = this.db.getGroupById(groupId);
                    this.isGroupChat = true;
                } else {
                    // We're opening a one-on-one chat
                    this.activeChat = this.db.getUserByName(friendName);
                    this.isGroupChat = false;
                }
                
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.messagesArea = document.getElementById('messages-area');
                this.chatList = document.getElementById('chat-list');
                
                // Initialize message memory for contextual responses
                this.chatMemory = {};
                
                // Set up status tracking
                this.setupStatusTracking();
                
                // Setup Group UI elements
                this.setupGroupUI();
                
                this.setupEventListeners();
                
                // Show loading indicator before loading chat history
                this.messagesArea.innerHTML = '<div class="loading-messages">Loading messages...</div>';
                
                // Load chat history with a small delay
                setTimeout(() => {
                    this.loadChatHistory();
                }, 500);
                
                // Update the active chat in the sidebar
                this.updateActiveChatInSidebar();
                
                // Simulate friend online/offline status randomly (only for individual chats)
                if (!this.isGroupChat) {
                    this.simulateFriendActivity();
                }
                
                // Load groups in sidebar
                this.loadGroupsInSidebar();
            }
            
            setupGroupUI() {
                // Create Group button in sidebar
                const createGroupBtn = document.getElementById('create-group-btn');
                const groupModal = document.getElementById('group-modal');
                const groupModalClose = document.getElementById('group-modal-close');
                const cancelGroupBtn = document.getElementById('cancel-group-btn');
                const createGroupSubmitBtn = document.getElementById('create-group-btn-submit');
                const contactSelect = document.getElementById('contact-select');
                const addMemberBtn = document.getElementById('add-member-btn');
                const selectedMembers = document.getElementById('selected-members');
                const groupNameInput = document.getElementById('group-name-input');
                
                // Group info button
                const groupInfoBtn = document.getElementById('group-info-btn');
                const chatInfoBtn = document.getElementById('chat-info-btn');
                
                // Group info modal
                const groupInfoModal = document.getElementById('group-info-modal');
                const groupInfoModalClose = document.getElementById('group-info-modal-close');
                const closeGroupInfoBtn = document.getElementById('close-group-info-btn');
                const leaveGroupBtn = document.getElementById('leave-group-btn');
                const groupInfoAddMemberBtn = document.getElementById('group-info-add-member-btn');
                const groupInfoContactSelect = document.getElementById('group-info-contact-select');
                
                // Toggle visibility based on chat type
                if (this.isGroupChat) {
                    chatInfoBtn.style.display = 'none';
                    groupInfoBtn.style.display = 'flex';
                } else {
                    chatInfoBtn.style.display = 'flex';
                    groupInfoBtn.style.display = 'none';
                }
                
                // Open Create Group modal
                createGroupBtn.addEventListener('click', () => {
                    this.openCreateGroupModal();
                });
                
                // Close Create Group modal
                groupModalClose.addEventListener('click', () => {
                    groupModal.style.display = 'none';
                });
                
                // Cancel button for Create Group modal
                cancelGroupBtn.addEventListener('click', () => {
                    groupModal.style.display = 'none';
                });
                
                // Create Group submit button
                createGroupSubmitBtn.addEventListener('click', () => {
                    const groupName = groupNameInput.value.trim();
                    if (!groupName) {
                        alert('Please enter a group name');
                        return;
                    }
                    
                    const selectedMemberIds = Array.from(selectedMembers.querySelectorAll('.member-item'))
                        .map(item => parseInt(item.dataset.userId));
                    
                    // Add current user to members
                    if (!selectedMemberIds.includes(this.currentUser.id)) {
                        selectedMemberIds.push(this.currentUser.id);
                    }
                    
                    if (selectedMemberIds.length < 3) {
                        alert('Please select at least 2 members (in addition to yourself)');
                        return;
                    }
                    
                    // Create the group
                    const newGroup = this.db.createGroup(groupName, selectedMemberIds, this.currentUser.id);
                    
                    // Add to sidebar
                    this.addGroupToSidebar(newGroup);
                    
                    // Close modal
                    groupModal.style.display = 'none';
                    
                    // Clear form
                    groupNameInput.value = '';
                    selectedMembers.innerHTML = '';
                });
                
                // Open Group Info modal
                groupInfoBtn.addEventListener('click', () => {
                    this.openGroupInfoModal();
                });
                
                // Close Group Info modal
                groupInfoModalClose.addEventListener('click', () => {
                    groupInfoModal.style.display = 'none';
                });
                
                // Close button for Group Info modal
                closeGroupInfoBtn.addEventListener('click', () => {
                    groupInfoModal.style.display = 'none';
                });
                
                // Leave Group button
                leaveGroupBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to leave this group?')) {
                        if (this.isGroupChat && this.activeChat) {
                            const groupId = this.activeChat.id;
                            const userId = this.currentUser.id;
                            
                            // Leave the group
                            this.db.removeMemberFromGroup(groupId, userId);
                            
                            // Close modal
                            groupInfoModal.style.display = 'none';
                            
                            // Redirect to default chat
                            window.location.href = 'message.html';
                        }
                    }
                });
                
                // Add Member button in Group Info modal
                groupInfoAddMemberBtn.addEventListener('click', () => {
                    const selectedContactId = parseInt(groupInfoContactSelect.value);
                    if (selectedContactId && this.isGroupChat && this.activeChat) {
                        const groupId = this.activeChat.id;
                        
                        // Add member to group
                        this.db.addMemberToGroup(groupId, selectedContactId);
                        
                        // Refresh group info modal
                        this.openGroupInfoModal();
                    }
                });
                
                // Add Member button in Create Group modal
                addMemberBtn.addEventListener('click', () => {
                    const selectedContactId = parseInt(contactSelect.value);
                    if (!selectedContactId) return;
                    
                    // Check if member is already added
                    const existingMember = selectedMembers.querySelector(`.member-item[data-user-id="${selectedContactId}"]`);
                    if (existingMember) return;
                    
                    // Get user details
                    const user = this.db.getUserById(selectedContactId);
                    if (!user) return;
                    
                    // Create member item
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.dataset.userId = user.id;
                    memberItem.innerHTML = `
                        <img src="${user.avatar}" alt="${user.name}" class="member-avatar">
                        <div class="member-name">${user.name}</div>
                        <button class="member-remove" data-user-id="${user.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add remove functionality
                    const removeBtn = memberItem.querySelector('.member-remove');
                    removeBtn.addEventListener('click', () => {
                        memberItem.remove();
                    });
                    
                    // Add to selected members
                    selectedMembers.appendChild(memberItem);
                });
            }
            
            setupStatusTracking() {
                // Track when user leaves or becomes inactive
                window.addEventListener('beforeunload', () => {
                    this.db.updateUserStatus(this.currentUser.id, false);
                });
                
                // Track visibility changes (tab switching)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        this.db.updateUserStatus(this.currentUser.id, false);
                    } else {
                        this.db.updateUserStatus(this.currentUser.id, true);
                    }
                });
                
                // Track user activity (mouse movement, typing)
                this.lastActivity = Date.now();
                this.isActive = true;
                
                const activityEvents = ['mousemove', 'keypress', 'click', 'touchstart', 'scroll'];
                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        this.lastActivity = Date.now();
                        
                        if (!this.isActive) {
                            this.isActive = true;
                            this.db.updateUserStatus(this.currentUser.id, true);
                        }
                    });
                });
                
                // Set up a heartbeat to check for inactivity
                this.activityTimer = setInterval(() => {
                    // Consider user inactive after 2 minutes of no activity
                    if (Date.now() - this.lastActivity > 120000) {
                        if (this.isActive) {
                            this.isActive = false;
                            this.db.updateUserStatus(this.currentUser.id, false);
                        }
                    }
                }, 30000); // Check every 30 seconds
                
                // Special tracking for when user is typing (more immediate "Active" status)
                this.messageInput.addEventListener('input', () => {
                    this.lastActivity = Date.now();
                    this.isActive = true;
                    this.db.updateUserStatus(this.currentUser.id, true);
                });
            }
            
            setupEventListeners() {
                // Send button click
                this.sendButton.addEventListener('click', () => {
                    console.log("Send button clicked");
                    this.sendMessage();
                });
                
                // Send on Enter (but allow shift+enter for new line)
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log("Enter key pressed");
                        this.sendMessage();
                    }
                });
                
                // Chat item selection
                this.setupChatItemListeners();
                
                // Apply theme from localStorage (without toggle functionality)
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                // Ensure the send button is properly initialized
                const sendBtn = document.getElementById('send-button');
                if (sendBtn) {
                    sendBtn.onclick = () => {
                        console.log("Send button clicked (backup handler)");
                        this.sendMessage();
                    };
                }
            }
            
            setupChatItemListeners() {
                // Function to handle chat item click
                const handleChatItemClick = (item) => {
                    console.log("Chat item clicked:", item);
                    document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const isGroup = item.hasAttribute('data-group-id');
                    
                    if (isGroup) {
                        const groupId = item.getAttribute('data-group-id');
                        const groupName = item.getAttribute('data-group-name');
                        const groupAvatar = item.getAttribute('data-group-avatar');
                        
                        console.log("Opening group chat:", groupName, groupId);
                        
                        // Clear previous chat state completely
                        this.activeChat = null;
                        this.isGroupChat = true;
                        
                        // Force clear messages area completely - remove all children
                        while (this.messagesArea.firstChild) {
                            this.messagesArea.removeChild(this.messagesArea.firstChild);
                        }
                        
                        // Add loading indicator
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'loading-messages';
                        loadingDiv.textContent = 'Loading group messages...';
                        this.messagesArea.appendChild(loadingDiv);
                        
                        // Get fresh group data
                        const group = this.db.getGroupById(groupId);
                        if (!group) {
                            console.error("Failed to load group data for ID:", groupId);
                            this.messagesArea.innerHTML = '<div class="date-divider error">Error: Group not found</div>';
                            return;
                        }
                        
                        this.activeChat = group;
                        console.log("Active chat set to group:", this.activeChat);
                        
                        // Update URL to include group parameter
                        const url = new URL(window.location.href);
                        url.searchParams.delete('friend');
                        url.searchParams.set('group', groupId);
                        window.history.pushState({}, '', url);
                        
                        // Toggle visibility of info buttons
                        document.getElementById('chat-info-btn').style.display = 'none';
                        document.getElementById('group-info-btn').style.display = 'flex';
                        
                        this.updateGroupChatHeader(groupName, groupAvatar);
                        
                        // Update chat name title for group
                        if (this.updateChatNameTitle) {
                            this.updateChatNameTitle();
                        }
                        
                        // Force immediate execution of loadGroupChatHistory
                        requestAnimationFrame(() => {
                            this.loadGroupChatHistory(groupId);
                        });
                    } else {
                        const userName = item.getAttribute('data-user');
                        const userAvatar = item.getAttribute('data-avatar');
                        const userStatus = item.getAttribute('data-status');
                        
                        console.log("Opening personal chat with:", userName);
                        
                        // Clear previous chat state completely
                        this.activeChat = null;
                        this.isGroupChat = false;
                        
                        // Force clear messages area completely - remove all children
                        while (this.messagesArea.firstChild) {
                            this.messagesArea.removeChild(this.messagesArea.firstChild);
                        }
                        
                        // Add loading indicator
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'loading-messages';
                        loadingDiv.textContent = 'Loading personal messages...';
                        this.messagesArea.appendChild(loadingDiv);
                        
                        // Get fresh user data
                        const user = this.db.getUserByName(userName);
                        if (!user) {
                            console.error("Failed to load user data for:", userName);
                            this.messagesArea.innerHTML = '<div class="date-divider error">Error: User not found</div>';
                            return;
                        }
                        
                        this.activeChat = user;
                        console.log("Active chat set to user:", this.activeChat);
                        
                        // Update URL to include friend parameter
                        const url = new URL(window.location.href);
                        url.searchParams.delete('group');
                        url.searchParams.set('friend', userName);
                        window.history.pushState({}, '', url);
                        
                        // Toggle visibility of info buttons
                        document.getElementById('chat-info-btn').style.display = 'flex';
                        document.getElementById('group-info-btn').style.display = 'none';
                        
                        this.updateChatHeader(userName, userAvatar, userStatus);
                        
                        // Update chat name title for personal chat
                        if (this.updateChatNameTitle) {
                            this.updateChatNameTitle();
                        }
                        
                        // Force immediate execution of loadChatHistory
                        requestAnimationFrame(() => {
                            this.loadChatHistory();
                        });
                    }
                    
                    // Move this chat to the top of the chat list if it's not already at the top
                    if (item !== this.chatList.firstChild) {
                        // Instead of cloning, just move the existing item
                        this.chatList.insertBefore(item, this.chatList.firstChild);
                    }
                    
                    // Remove unread badge if present
                    const unreadBadge = item.querySelector('.unread-badge');
                    if (unreadBadge) {
                        unreadBadge.remove();
                    }
                };
                
                // Add click listeners to all chat items
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.removeEventListener('click', () => handleChatItemClick(item)); // Remove any existing listener
                    item.addEventListener('click', () => handleChatItemClick(item));
                });
            }
            
            updateChatHeader(name, avatar, status) {
                document.getElementById('chat-with-name').textContent = name;
                document.getElementById('chat-with-avatar').src = avatar;
                
                const statusIndicator = document.querySelector('.chat-with-status .status-indicator');
                const statusText = document.querySelector('.chat-with-status');
                
                if (status === 'online') {
                    // For online users, we'll show "Active" specifically when they are chatting
                    statusIndicator.style.background = 'var(--success-color)';
                    
                    // Check if the person was active very recently (within the last 30 seconds)
                    const lastActivity = this.activeChat.lastActivity || 0;
                    const isActivelyChatting = Date.now() - lastActivity < 30000;
                    
                    if (isActivelyChatting) {
                        statusText.innerHTML = '<span class="status-indicator"></span> Active now';
                    } else {
                        statusText.innerHTML = '<span class="status-indicator"></span> Online';
                    }
                    
                    statusText.style.color = 'var(--success-color)';
                } else {
                    // For offline users, show when they were last seen
                    const lastSeen = this.activeChat ? this.db.getLastSeen(this.activeChat.id) : 'a while ago';
                    statusIndicator.style.background = 'var(--text-muted)';
                    statusText.innerHTML = `<span class="status-indicator"></span> Last seen ${lastSeen}`;
                    statusText.style.color = 'var(--text-muted)';
                }
            }
            
            loadChatHistory() {
                // Force clear existing messages completely
                while (this.messagesArea.firstChild) {
                    this.messagesArea.removeChild(this.messagesArea.firstChild);
                }
                
                // Add loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-messages';
                loadingDiv.textContent = 'Loading personal messages...';
                this.messagesArea.appendChild(loadingDiv);
                
                // Validate active chat
                if (!this.activeChat) {
                    console.error("No active chat when trying to load history");
                    this.messagesArea.innerHTML = '<div class="date-divider error">Error: No active chat selected</div>';
                    return;
                }
                
                // Make sure we are not trying to load a group chat with this function
                if (this.isGroupChat) {
                    console.error("Attempting to load personal chat history for a group chat");
                    this.messagesArea.innerHTML = '';
                    return;
                }
                
                console.log("Loading chat history for conversation between", this.currentUser.id, "and", this.activeChat.id);
                
                try {
                    // Get conversation from database
                    const conversation = this.db.getConversation(this.currentUser.id, this.activeChat.id);
                    if (!conversation) {
                        console.error("Failed to load conversation data");
                        this.messagesArea.innerHTML = '<div class="date-divider">No conversation found</div>';
                        return;
                    }
                    
                    console.log("Conversation data:", conversation);
                    
                    // Handle case where there are no messages yet
                    const messages = conversation.messages || [];
                    
                    if (messages.length === 0) {
                        console.log("No messages in this conversation yet");
                        this.messagesArea.innerHTML = '<div class="date-divider">No messages yet</div>';
                        return;
                    }
                    
                    // Group messages by date for better display
                    const messagesByDate = this.groupMessagesByDate(messages);
                    
                    // Display messages grouped by date
                    for (const [date, msgs] of Object.entries(messagesByDate)) {
                        // Add date divider
                        const dateDivider = document.createElement('div');
                        dateDivider.className = 'date-divider';
                        dateDivider.textContent = date;
                        this.messagesArea.appendChild(dateDivider);
                        
                        // Add messages for this date
                        msgs.forEach(message => {
                            const isCurrentUser = message.senderId === this.currentUser.id;
                            this.addMessageToUI(message.text, isCurrentUser, this.formatTime(message.timestamp), message.id);
                        });
                    }
                    
                    // Update chat memory with all messages for better contextual responses
                    messages.forEach(message => {
                        const isFromCurrentUser = message.senderId === this.currentUser.id;
                        this.updateChatMemory(this.activeChat.id, message.text, isFromCurrentUser);
                    });
                    
                } catch (error) {
                    console.error("Error loading chat history:", error);
                    this.messagesArea.innerHTML = '<div class="date-divider">Error loading messages</div>';
                }
                
                this.scrollToBottom();
            }
            
            // Helper function to group messages by date
            groupMessagesByDate(messages) {
                const groups = {};
                
                messages.forEach(message => {
                    const date = new Date(message.timestamp);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    let dateStr;
                    
                    if (date.toDateString() === today.toDateString()) {
                        dateStr = "Today";
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        dateStr = "Yesterday";
                    } else {
                        dateStr = date.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }
                    
                    if (!groups[dateStr]) {
                        groups[dateStr] = [];
                    }
                    
                    groups[dateStr].push(message);
                });
                
                return groups;
            }
            
            // Original function without reply functionality
            
            openCreateGroupModal() {
                const groupModal = document.getElementById('group-modal');
                const contactSelect = document.getElementById('contact-select');
                const selectedMembers = document.getElementById('selected-members');
                
                // Clear previous values
                document.getElementById('group-name-input').value = '';
                selectedMembers.innerHTML = '';
                
                // Get all users from localStorage
                let users = [];
                try {
                    const allUsers = JSON.parse(localStorage.getItem('wechat_users')) || [];
                    // Filter out current user from the list
                    users = allUsers.filter(user => user.id !== this.currentUser.id);
                    console.log("All available users for group:", users);
                } catch (e) {
                    console.error("Error fetching users:", e);
                    // Fallback to hardcoded users if there's an error
                    users = [
                        {id: 2, name: 'Ogety Karthik', avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face'},
                        {id: 3, name: 'Suman', avatar: 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=150&h=150&fit=crop&crop=face'},
                        {id: 4, name: 'Vamsi', avatar: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&h=150&fit=crop&crop=face'},
                        {id: 5, name: 'Badri', avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face'},
                        {id: 6, name: 'Sai', avatar: 'https://images.unsplash.com/photo-1566492031773-4f4e44671d66?w=150&h=150&fit=crop&crop=face'},
                        {id: 7, name: 'Harsha', avatar: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=150&h=150&fit=crop&crop=face'},
                        {id: 8, name: 'Anushka', avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b4ab?w=150&h=150&fit=crop&crop=face'}
                    ];
                }
                
                // Populate contact select with ALL users
                contactSelect.innerHTML = '<option value="">Select a contact</option>';
                users.forEach(user => {
                    contactSelect.innerHTML += `<option value="${user.id}">${user.name}</option>`;
                });
                
                // Show modal
                groupModal.style.display = 'flex';
            }
            
            openGroupInfoModal() {
                if (!this.isGroupChat || !this.activeChat) return;
                
                const groupInfoModal = document.getElementById('group-info-modal');
                const groupInfoName = document.getElementById('group-info-name');
                const groupInfoCreatedBy = document.getElementById('group-info-created-by');
                const groupMembersList = document.getElementById('group-members-list');
                const groupInfoContactSelect = document.getElementById('group-info-contact-select');
                
                // Set group name
                groupInfoName.value = this.activeChat.name;
                
                // Set created by
                const creator = this.db.getUserById(this.activeChat.createdBy);
                groupInfoCreatedBy.value = creator ? creator.name : 'Unknown';
                
                // Populate members list
                groupMembersList.innerHTML = '';
                this.activeChat.members.forEach(memberId => {
                    const member = this.db.getUserById(memberId);
                    if (member) {
                        const memberElement = document.createElement('div');
                        memberElement.className = 'group-member';
                        memberElement.innerHTML = `
                            <img src="${member.avatar}" alt="${member.name}" class="group-member-avatar">
                            <div class="group-member-name">${member.name}</div>
                        `;
                        groupMembersList.appendChild(memberElement);
                    }
                });
                
                // Fetch all users from localStorage
                let allUsers = [];
                try {
                    allUsers = JSON.parse(localStorage.getItem('wechat_users')) || [];
                    console.log("All users for group info:", allUsers);
                } catch (e) {
                    console.error("Error fetching users for group info:", e);
                    // Fallback to using only the available users by ID
                    allUsers = [1, 2, 3, 4, 5, 6, 7, 8].map(id => this.db.getUserById(id)).filter(u => u);
                }
                
                // Filter out users who are already in the group
                const nonMembers = allUsers.filter(user => !this.activeChat.members.includes(user.id));
                
                groupInfoContactSelect.innerHTML = '<option value="">Select a contact</option>';
                nonMembers.forEach(user => {
                    groupInfoContactSelect.innerHTML += `<option value="${user.id}">${user.name}</option>`;
                });
                
                // Show modal
                groupInfoModal.style.display = 'flex';
            }
            
            loadGroupsInSidebar() {
                // Get groups for current user
                const groups = this.db.getGroupsForUser(this.currentUser.id);
                
                // Add each group to sidebar
                groups.forEach(group => {
                    this.addGroupToSidebar(group);
                });
            }
            
            addGroupToSidebar(group) {
                // Create chat item for group
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-group-id', group.id);
                chatItem.setAttribute('data-group-name', group.name);
                chatItem.setAttribute('data-group-avatar', group.avatar);
                
                // Get last message from group conversation
                const conversation = this.db.getGroupConversation(group.id);
                const lastMessage = conversation.messages && conversation.messages.length > 0 ? 
                    conversation.messages[conversation.messages.length - 1] : null;
                
                // Get sender name
                let senderName = '';
                if (lastMessage) {
                    if (lastMessage.senderId === this.currentUser.id) {
                        senderName = 'You: ';
                    } else {
                        const sender = this.db.getUserById(lastMessage.senderId);
                        senderName = sender ? sender.name.split(' ')[0] + ': ' : '';
                    }
                }
                
                chatItem.innerHTML = `
                    <img src="${group.avatar}" alt="${group.name}" class="chat-avatar">
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name group-chat">${group.name}</div>
                            <div class="chat-time">${lastMessage ? this.formatTime(lastMessage.timestamp) : ''}</div>
                        </div>
                        <div class="chat-message">${lastMessage ? senderName + lastMessage.text : 'No messages yet'}</div>
                    </div>
                `;
                
                // Add to chat list
                this.chatList.appendChild(chatItem);
                
                // Add event listener
                this.setupChatItemListeners();
            }
            
            addFriendToSidebar(user) {
                // Check if this user is already in the sidebar
                const existingItem = document.querySelector(`.chat-item[data-user="${user.name}"]`);
                if (existingItem) {
                    return; // User already exists in sidebar
                }
                
                // Create chat item for the user
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-user', user.name);
                chatItem.setAttribute('data-avatar', user.avatar);
                chatItem.setAttribute('data-status', user.status);
                
                // Get last message from conversation
                const conversation = this.db.getConversation(this.currentUser.id, user.id);
                const lastMessage = conversation && conversation.messages && conversation.messages.length > 0 ? 
                    conversation.messages[conversation.messages.length - 1] : null;
                
                const onlineStatus = user.status === 'online';
                
                // Format the message preview (sender name + message or "No messages")
                let messagePreview = 'No messages yet';
                if (lastMessage) {
                    if (lastMessage.senderId === this.currentUser.id) {
                        messagePreview = `You: ${this.truncateText(lastMessage.text, 30)}`;
                    } else {
                        messagePreview = this.truncateText(lastMessage.text, 36);
                    }
                }
                
                chatItem.innerHTML = `
                    <img src="${user.avatar}" alt="${user.name}" class="chat-avatar">
                    ${onlineStatus ? '<div class="online-indicator"></div>' : ''}
                    <div class="chat-details">
                        <div class="chat-top">
                            <div class="chat-name">${user.name}</div>
                            <div class="chat-time">${lastMessage ? this.formatTime(lastMessage.timestamp) : ''}</div>
                        </div>
                        <div class="chat-message">${messagePreview}</div>
                    </div>
                `;
                
                // Add to chat list at the top
                this.chatList.insertBefore(chatItem, this.chatList.firstChild);
                
                // Add event listener
                this.setupChatItemListeners();
            }
            
            updateGroupChatHeader(groupName, groupAvatar) {
                document.getElementById('chat-with-name').textContent = groupName;
                document.getElementById('chat-with-avatar').src = groupAvatar;
                
                // Update status to show number of members
                const memberCount = this.activeChat.members.length;
                const statusText = document.querySelector('.chat-with-status');
                statusText.innerHTML = `<i class="fas fa-users"></i> ${memberCount} members`;
                statusText.style.color = 'var(--text-secondary)';
            }
            
            loadGroupChatHistory(groupId) {
                // Force clear existing messages completely
                while (this.messagesArea.firstChild) {
                    this.messagesArea.removeChild(this.messagesArea.firstChild);
                }
                
                // Add loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-messages';
                loadingDiv.textContent = 'Loading group messages...';
                this.messagesArea.appendChild(loadingDiv);
                
                if (!groupId) {
                    console.error("No group ID provided to loadGroupChatHistory");
                    this.messagesArea.innerHTML = '<div class="date-divider error">Error: Invalid group chat</div>';
                    return;
                }
                
                try {
                    const conversation = this.db.getGroupConversation(groupId);
                    
                    if (!conversation) {
                        console.error("No conversation found for group:", groupId);
                        this.messagesArea.innerHTML = '<div class="date-divider">No messages in this group yet</div>';
                        return;
                    }
                    
                    // Clear the messages area and add the date divider
                    this.messagesArea.innerHTML = '<div class="date-divider">Group Messages</div>';
                    
                    const messages = conversation.messages || [];
                    
                    if (messages.length === 0) {
                        this.messagesArea.innerHTML += '<div class="no-messages">No messages yet. Be the first to say something!</div>';
                        return;
                    }
                    
                    messages.forEach(message => {
                        const isCurrentUser = message.senderId === this.currentUser.id;
                        const sender = this.db.getUserById(message.senderId);
                        const senderName = sender ? sender.name : 'Unknown';
                        
                        this.addGroupMessageToUI(message.text, isCurrentUser, this.formatTime(message.timestamp), message.id, senderName);
                    });
                    
                    this.scrollToBottom();
                } catch (error) {
                    console.error("Error loading group chat history:", error);
                    this.messagesArea.innerHTML = '<div class="date-divider error">Error loading group messages</div>';
                }
            }
            
            addGroupMessageToUI(text, isCurrentUser, time, messageId, senderName) {
                const messageElement = document.createElement('div');
                messageElement.className = isCurrentUser ? 'message message-sent' : 'message message-received';
                messageElement.dataset.messageId = messageId;
                
                // Only show sender name for messages not from current user
                const senderDisplay = isCurrentUser ? '' : `<div class="message-sender">${senderName}</div>`;
                
                messageElement.innerHTML = `
                    ${senderDisplay}
                    <div class="message-content">${this.formatMessageContent(text)}</div>
                    <div class="message-time">${time}</div>
                    <div class="message-options">
                        <div class="message-option reply" title="Reply">
                            <i class="fas fa-reply"></i>
                        </div>
                        ${isCurrentUser ? `
                        <div class="message-option delete" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Add event listeners for message actions
                const replyButton = messageElement.querySelector('.message-option.reply');
                if (replyButton) {
                    replyButton.addEventListener('click', () => {
                        // Implement reply functionality
                        alert('Reply functionality coming soon!');
                    });
                }
                
                const deleteButton = messageElement.querySelector('.message-option.delete');
                if (deleteButton) {
                    deleteButton.addEventListener('click', () => {
                        this.deleteMessage(messageId);
                    });
                }
                
                // Add context menu for right-click
                messageElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, messageId, isCurrentUser);
                });
                
                this.messagesArea.appendChild(messageElement);
            }
            
            sendMessage() {
                const text = this.messageInput.value.trim();
                console.log("Attempting to send message:", text);
                
                if (!text) {
                    console.log("Message is empty, not sending");
                    return;
                }
                
                if (!this.activeChat) {
                    console.error("No active chat selected");
                    alert("Please select a chat first");
                    return;
                }
                
                console.log("Active chat:", this.activeChat);
                console.log("Current user:", this.currentUser);
                
                // Update user activity status when sending a message
                this.db.updateUserActivity(this.currentUser.id);
                
                // Check if this is a group chat (by checking if activeChat has members property)
                const isGroupChat = this.activeChat && this.activeChat.members !== undefined;
                console.log("Is group chat:", isGroupChat);
                
                if (isGroupChat) {
                    console.log("Sending group message to:", this.activeChat.id, "Text:", text);
                    
                    try {
                        // Send message to group
                        const message = this.db.sendGroupMessage(this.activeChat.id, this.currentUser.id, text);
                        console.log("Group message sent:", message);
                        console.log("Group message saved to localStorage successfully");
                        
                        // Verify the group message was saved by checking localStorage
                        const savedGroupConversations = JSON.parse(localStorage.getItem('wechat_group_conversations')) || {};
                        const savedGroupConversation = savedGroupConversations[this.activeChat.id];
                        if (savedGroupConversation && savedGroupConversation.messages.length > 0) {
                            console.log("✅ Group message persistence verified - Total messages:", savedGroupConversation.messages.length);
                            console.log("✅ Latest group message:", savedGroupConversation.messages[savedGroupConversation.messages.length - 1]);
                        } else {
                            console.error("❌ Group message was not saved properly to localStorage");
                        }
                        
                        // Add message to UI
                        this.addGroupMessageToUI(text, true, this.formatTime(message.timestamp), message.id, 'You');
                        
                        // Update the group chat preview in the chat list
                        const chatItem = document.querySelector(`.chat-item[data-group-id="${this.activeChat.id}"]`);
                        if (chatItem) {
                            const messagePreview = chatItem.querySelector('.chat-message');
                            if (messagePreview) {
                                messagePreview.textContent = `You: ${text}`;
                            }
                            
                            const timeElement = chatItem.querySelector('.chat-time');
                            if (timeElement) {
                                timeElement.textContent = this.formatTime(message.timestamp);
                            }
                        }
                        
                        // Move this chat to the top of the chat list
                        const groupItem = document.querySelector(`.chat-item[data-group-id="${this.activeChat.id}"]`);
                        if (groupItem && this.chatList.firstChild !== groupItem) {
                            this.chatList.insertBefore(groupItem, this.chatList.firstChild);
                        }
                    } catch (e) {
                        console.error("Error sending group message:", e);
                        alert("Failed to send message. Please try again.");
                    }
                } else {
                    console.log("Sending individual message to:", this.activeChat.name);
                    
                    try {
                        // Send message to individual user
                        const message = this.db.sendMessage(this.currentUser.id, this.activeChat.id, text);
                        console.log("Message sent:", message);
                        console.log("Message saved to localStorage successfully");
                        
                        // Verify the message was saved by checking localStorage
                        const savedConversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                        const conversationKey = this.db.getConversationKey(this.currentUser.id, this.activeChat.id);
                        const savedConversation = savedConversations[conversationKey];
                        if (savedConversation && savedConversation.messages.length > 0) {
                            console.log("✅ Message persistence verified - Total messages:", savedConversation.messages.length);
                            console.log("✅ Latest message:", savedConversation.messages[savedConversation.messages.length - 1]);
                        } else {
                            console.error("❌ Message was not saved properly to localStorage");
                        }
                        
                        // Add message to UI
                        this.addMessageToUI(text, true, this.formatTime(message.timestamp), message.id);
                        
                        // Update chat memory with user's message
                        this.updateChatMemory(this.activeChat.id, text, true);
                        console.log("Chat memory updated");
                        
                        console.log("Message added to UI");
                        
                        // Debug friend status
                        console.log("Friend status:", this.activeChat.status);
                        
                        // Update the last message preview in the chat list
                        const chatItem = document.querySelector(`.chat-item[data-user="${this.activeChat.name}"]`);
                        console.log("Chat item for update:", chatItem);
                        
                        if (chatItem) {
                            const messagePreview = chatItem.querySelector('.chat-message');
                            if (messagePreview) {
                                messagePreview.textContent = text;
                                console.log("Message preview updated");
                            }
                            
                            // Also update the time
                            const timeElement = chatItem.querySelector('.chat-time');
                            if (timeElement) {
                                timeElement.textContent = this.formatTime(message.timestamp);
                            }
                        } else {
                            console.log("Chat item not found, using fallback");
                            // Fallback to the old method if chat item not found
                            const preview = document.getElementById('last-message-preview');
                            if (preview) {
                                preview.textContent = text;
                                console.log("Last message preview updated");
                            }
                        }
                        
                        // Move this chat to the top of the chat list
                        this.moveChatToTop(this.activeChat.name);
                        
                        // Simulate response after a delay (for demo purposes)
                        console.log("Simulating typing indicator with force=true");
                        this.simulateTypingIndicator(true); // Force typing simulation
                    } catch (e) {
                        console.error("Error sending individual message:", e);
                        alert("Failed to send message. Please try again.");
                    }
                }
                
                // Clear input
                this.messageInput.value = '';
                console.log("Message input cleared");
                
                // Scroll to bottom
                this.scrollToBottom();
                
                // Play message sent notification sound
                console.log("Playing notification sound");
                try {
                    playNotificationSound('sent');
                } catch (e) {
                    console.error("Error playing notification sound:", e);
                }
            }
            
            addMessageToUI(text, isCurrentUser, time, messageId) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'message-sent' : 'message-received'}`;
                // Generate a unique ID if none provided
                messageId = messageId || `msg-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                messageElement.dataset.messageId = messageId;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = text;
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = time;
                
                if (isCurrentUser) {
                    const messageStatus = document.createElement('span');
                    messageStatus.className = 'message-status';
                    messageStatus.innerHTML = '<i class="fas fa-check-double"></i>';
                    messageTime.appendChild(messageStatus);
                }
                
                // Add message options
                const messageOptions = document.createElement('div');
                messageOptions.className = 'message-options';
                
                if (isCurrentUser) {
                    // Only allow deletion of user's own messages
                    const deleteOption = document.createElement('div');
                    deleteOption.className = 'message-option delete';
                    deleteOption.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteOption.title = 'Delete';
                    deleteOption.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteMessage(messageId);
                    });
                    messageOptions.appendChild(deleteOption);
                }
                
                messageElement.appendChild(messageContent);
                messageElement.appendChild(messageTime);
                messageElement.appendChild(messageOptions);
                
                // Add context menu functionality
                messageElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showMessageContextMenu(e, messageId, isCurrentUser);
                });
                
                this.messagesArea.appendChild(messageElement);
                this.scrollToBottom();
                
                return messageElement;
            }
            
            deleteMessage(messageId) {
                // Show confirmation dialog
                if (confirm('Are you sure you want to delete this message?')) {
                    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    
                    if (messageElement) {
                        // Add delete animation
                        messageElement.style.animation = 'fadeOut 0.3s ease forwards';
                        
                        // Remove message after animation completes
                        setTimeout(() => {
                            messageElement.remove();
                            
                            // Remove from storage/database
                            // Note: In a real app, you would also remove it from your actual database
                            const conversationKey = this.db.getConversationKey(this.currentUser.id, this.activeChat.id);
                            const conversations = JSON.parse(localStorage.getItem('wechat_conversations'));
                            
                            if (conversations[conversationKey] && conversations[conversationKey].messages) {
                                const messageIndex = conversations[conversationKey].messages.findIndex(msg => msg.id === messageId);
                                
                                if (messageIndex !== -1) {
                                    conversations[conversationKey].messages.splice(messageIndex, 1);
                                    localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                                }
                            }
                        }, 300);
                    }
                }
            }
            
            // Move a chat to the top of the chat list
            moveChatToTop(userName) {
                const chatItem = document.querySelector(`.chat-item[data-user="${userName}"]`);
                if (!chatItem) return;
                
                // Get the chat list
                const chatList = document.getElementById('chat-list');
                
                // Only move if not already at the top
                if (chatItem !== chatList.firstChild) {
                    // Move the chat item to the top
                    chatList.insertBefore(chatItem, chatList.firstChild);
                    
                    // Add a subtle highlight animation
                    chatItem.style.animation = 'none';
                    setTimeout(() => {
                        chatItem.style.animation = 'highlight 2s ease';
                    }, 10);
                }
            }
            
            showMessageContextMenu(e, messageId, isCurrentUser) {
                // Remove existing menus
                document.querySelectorAll('.message-context-menu').forEach(menu => menu.remove());
                
                const contextMenu = document.createElement('div');
                contextMenu.className = 'message-context-menu';
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                
                // Add copy option
                const copyOption = document.createElement('div');
                copyOption.className = 'menu-option';
                copyOption.innerHTML = '<i class="far fa-copy"></i> Copy';
                copyOption.addEventListener('click', () => {
                    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        const text = messageElement.querySelector('.message-content').textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            // Show copy feedback (could be a toast or alert)
                            alert('Text copied to clipboard!');
                        });
                    }
                    contextMenu.remove();
                });
                contextMenu.appendChild(copyOption);
                
                // Add forward option
                const forwardOption = document.createElement('div');
                forwardOption.className = 'menu-option';
                forwardOption.innerHTML = '<i class="fas fa-share"></i> Forward';
                forwardOption.addEventListener('click', () => {
                    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        const text = messageElement.querySelector('.message-content').textContent;
                        alert(`Message would be forwarded: ${text}`);
                        // In a real app, you would show a friend selection dialog here
                    }
                    contextMenu.remove();
                });
                contextMenu.appendChild(forwardOption);
                
                // Add delete option (only for user's own messages)
                if (isCurrentUser) {
                    const deleteOption = document.createElement('div');
                    deleteOption.className = 'menu-option delete';
                    deleteOption.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                    deleteOption.addEventListener('click', () => {
                        this.deleteMessage(messageId);
                        contextMenu.remove();
                    });
                    contextMenu.appendChild(deleteOption);
                }
                
                document.body.appendChild(contextMenu);
                
                // Close menu when clicking outside
                document.addEventListener('click', function closeMenu() {
                    contextMenu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }
            
            simulateTypingIndicator(forceTyping) {
                console.log("simulateTypingIndicator called with forceTyping =", forceTyping);
                console.log("Active chat:", this.activeChat);
                console.log("Is group chat:", this.isGroupChat);
                
                // Ensure we have an active chat
                if (!this.activeChat) {
                    console.error("No active chat found!");
                    return;
                }
                
                // Skip typing indicator for group chats
                if (this.isGroupChat) {
                    console.log("Skipping typing indicator for group chat");
                    return;
                }
                
                // Check if activeChat has a valid structure for personal chat
                if (!this.activeChat.id || !this.activeChat.name || !this.activeChat.avatar) {
                    console.error("Invalid active chat structure:", this.activeChat);
                    return;
                }
                
                console.log("Active chat status:", this.activeChat.status || "No status");
                
                // Always update the friend's status to online for demo purposes
                const updatedUser = this.db.updateUserActivity(this.activeChat.id);
                this.activeChat.status = 'online'; // Update the local status
                
                console.log("Updated friend status to online:", updatedUser);
                this.updateChatHeader(this.activeChat.name, this.activeChat.avatar, 'online');
                
                // Only show typing if friend is online or if forced
                if (this.activeChat && (this.activeChat.status === 'online' || forceTyping)) {
                    console.log("Showing typing indicator");
                    
                    setTimeout(() => {
                        const typingIndicator = document.createElement('div');
                        typingIndicator.className = 'typing-indicator message-received';
                        typingIndicator.innerHTML = `
                            ${this.activeChat.name} is typing
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        `;
                        
                        this.messagesArea.appendChild(typingIndicator);
                        this.scrollToBottom();
                        
                        // Remove typing indicator and send response after a delay
                        setTimeout(() => {
                            typingIndicator.remove();
                            
                            // If we're forcing typing, we should also force a message response
                            if (forceTyping || Math.random() >= 0) { // 100% chance of responding for debugging
                                console.log("Generating friend response");
                                // Update friend activity when sending a message
                                this.db.updateUserActivity(this.activeChat.id);
                                
                                // Find the last message from the current user that could be replied to
                                const messages = document.querySelectorAll('.message.message-sent');
                                const lastMessage = messages[messages.length - 1];
                                
                                let lastMessageText = "";
                                
                                if (lastMessage) {
                                    const messageContent = lastMessage.querySelector('.message-content');
                                    if (messageContent) {
                                        lastMessageText = messageContent.textContent.toLowerCase().trim();
                                        console.log("Last message text:", lastMessageText);
                                    }
                                }
                                
                                // Analyze message type (question, statement, greeting, etc.)
                                const messageType = this.analyzeMessageType(lastMessageText);
                                console.log("Detected message type:", messageType);
                                
                                // Check if we have a valid active chat
                                if (!this.activeChat || !this.activeChat.id) {
                                    console.error("Invalid active chat when generating response");
                                    return;
                                }
                                
                                console.log("Generating response for active chat:", this.activeChat.name, this.activeChat.id);
                                
                                // Check chat memory for more contextually relevant response
                                const memoryResponse = this.getContextualResponseFromMemory(this.activeChat.id, messageType);
                                
                                // Create contextual responses based on the last message content
                                let contextualResponses = [];
                                
                                // If we have a memory-based response, use it with high priority
                                if (memoryResponse) {
                                    contextualResponses.push(memoryResponse);
                                    console.log("Using memory-based response:", memoryResponse);
                                }
                                
                                // Generate contextual responses based on message type and keywords
                                switch (messageType) {
                                    case 'greeting':
                                        contextualResponses = [
                                            "Hi there! How are you?", 
                                            "Hey! Good to hear from you!", 
                                            "Hello! How's your day going?",
                                            "Hi! Hope you're having a good day!",
                                            "Hey there! What's new?"
                                        ];
                                        break;
                                        
                                    case 'question':
                                        if (lastMessageText.includes("how are you") || lastMessageText.includes("how's it going")) {
                                            contextualResponses = [
                                                "I'm doing well, thanks for asking! How about you?", 
                                                "Pretty good! Just busy with work. You?", 
                                                "Not bad at all. What's new with you?",
                                                "I'm great! Working on some exciting projects. How are things on your end?",
                                                "Doing well! Just finished a productive meeting. How's your day going?"
                                            ];
                                        } else if (lastMessageText.includes("time") || lastMessageText.includes("when") || lastMessageText.includes("schedule")) {
                                            contextualResponses = [
                                                "How about tomorrow at 2 PM?", 
                                                "I'm free this afternoon if that works for you.", 
                                                "Let's schedule it for next week.",
                                                "I have availability on Thursday afternoon or Friday morning.",
                                                "Would sometime early next week work for you? I'm quite booked until then."
                                            ];
                                        } else if (lastMessageText.includes("think") || lastMessageText.includes("opinion")) {
                                            contextualResponses = [
                                                "I think that's a great idea! We should definitely explore it further.",
                                                "My opinion is that we should take a step back and reconsider our approach.",
                                                "I believe we're on the right track, but we might need to adjust our timeline.",
                                                "That's an interesting perspective. Have you considered looking at it from this angle?",
                                                "I'm not entirely convinced yet, but I'm open to discussing it more."
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "That's a good question. Let me think about it.",
                                                "Interesting question! I'd say it depends on several factors.",
                                                "Great question! I've been considering that myself recently.",
                                                "I'm not entirely sure, but my best guess would be...",
                                                "Let me look into that and get back to you with a more detailed answer."
                                            ];
                                        }
                                        break;
                                        
                                    case 'meeting':
                                        contextualResponses = [
                                            "Sure, when do you want to schedule the meeting?", 
                                            "I'm available for a meeting tomorrow afternoon.", 
                                            "Let me check my calendar and get back to you about that meeting.",
                                            "A meeting sounds good. How about Wednesday at 10 AM?",
                                            "I can fit a quick meeting in today if it's urgent, otherwise let's do it tomorrow."
                                        ];
                                        break;
                                        
                                    case 'work':
                                        contextualResponses = [
                                            "The project is coming along well!", 
                                            "I've made good progress on that task.", 
                                            "Let's discuss the project details soon.",
                                            "I've completed about 70% of my assigned tasks for this sprint.",
                                            "I'm running into some challenges with the current implementation. Can we discuss alternatives?"
                                        ];
                                        break;
                                        
                                    case 'gratitude':
                                        contextualResponses = [
                                            "You're welcome!", 
                                            "No problem at all!", 
                                            "Glad I could help!",
                                            "Happy to be of assistance!",
                                            "Anytime! Don't hesitate to ask if you need anything else."
                                        ];
                                        break;
                                        
                                    case 'farewell':
                                        contextualResponses = [
                                            "Talk to you later!",
                                            "Have a great day!",
                                            "Bye for now!",
                                            "See you soon!",
                                            "Take care! Chat again soon."
                                        ];
                                        break;
                                        
                                    default:
                                        if (lastMessageText.includes("help") || lastMessageText.includes("assist")) {
                                            contextualResponses = [
                                                "I'd be happy to help! What do you need?", 
                                                "Sure, I can assist with that.", 
                                                "Let me know what you need help with.",
                                                "I'll do my best to help you with that.",
                                                "Let me see what I can do to help."
                                            ];
                                        } else if (lastMessageText.includes("weekend") || lastMessageText.includes("plans")) {
                                            contextualResponses = [
                                                "I have some exciting plans for the weekend!", 
                                                "Not much planned yet, how about you?", 
                                                "Thinking of taking it easy this weekend.",
                                                "I might go hiking if the weather's nice. Any recommendations?",
                                                "Planning to catch up on some reading and maybe see friends. You?"
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "That makes sense!",
                                                "I see what you mean.",
                                                "Interesting perspective!",
                                                "I hadn't thought about it that way before.",
                                                "Thanks for sharing that with me."
                                            ];
                                        }
                                }
                                
                                // Personalized responses based on friend's name and the message context
                                if (this.activeChat.name === "Ogety Karthik") {
                                    if (lastMessageText.includes("project") || lastMessageText.includes("deadline")) {
                                        contextualResponses = [
                                            "I'm working on the project now, should be done by tomorrow.",
                                            "The deadline is tight, but I think we can make it.",
                                            "I've completed about 70% of the project tasks already."
                                        ];
                                    } else if (lastMessageText.includes("meeting") || lastMessageText.includes("discuss")) {
                                        contextualResponses = [
                                            "Let's meet tomorrow at 3 PM in the conference room.",
                                            "I'm free after lunch if you want to discuss the details.",
                                            "Sure, I'll prepare the slides for our discussion."
                                        ];
                                    } else if (contextualResponses.length === 0) {
                                        contextualResponses = [
                                            "Hey, how's it going?",
                                            "What are you working on these days?",
                                            "Have you completed that project yet?",
                                            "Let's meet up sometime this week!",
                                            "I saw your message earlier, was quite busy.",
                                            "That sounds interesting, tell me more!",
                                            "I'm thinking of organizing a team event next month.",
                                            "Did you check out that new framework I mentioned?"
                                        ];
                                    }
                                } else if (this.activeChat.name === "Suman") {
                                    if (lastMessageText.includes("coffee") || lastMessageText.includes("meet")) {
                                        contextualResponses = [
                                            "Coffee sounds great! How about tomorrow morning?",
                                            "I'd love to meet up. The new café downtown is nice.",
                                            "Let's grab coffee at 10 AM if that works for you."
                                        ];
                                    } else if (lastMessageText.includes("movie") || lastMessageText.includes("watch")) {
                                        contextualResponses = [
                                            "Yes, I saw that new movie! It was amazing!",
                                            "I haven't watched it yet. Would you recommend it?",
                                            "Let's go watch it this weekend if you're free."
                                        ];
                                    } else if (contextualResponses.length === 0) {
                                        contextualResponses = [
                                            "Hey! Are you coming to the meeting?",
                                            "Thanks for checking in!",
                                            "I've been working on that project we discussed",
                                            "Let's grab coffee sometime this week",
                                            "Did you see that new movie?",
                                            "How's your day going?",
                                            "I'm free this evening if you want to meet up"
                                        ];
                                    }
                                } else if (this.activeChat.name === "Vamsi") {
                                    if (lastMessageText.includes("help") || lastMessageText.includes("need")) {
                                        contextualResponses = [
                                            "I'll help you out with that right away.",
                                            "What specifically do you need help with?",
                                            "Sure, I can take a look at it this afternoon."
                                        ];
                                    } else if (lastMessageText.includes("presentation") || lastMessageText.includes("review")) {
                                        contextualResponses = [
                                            "The presentation went very well, thanks!",
                                            "I've made the changes you suggested to the slides.",
                                            "Let's review the presentation once more before the client meeting."
                                        ];
                                    } else if (contextualResponses.length === 0) {
                                        contextualResponses = [
                                            "Thanks for helping with the project!",
                                            "I really appreciate your input on that issue",
                                            "Are we still on for tomorrow?",
                                            "Have you checked out that new framework?",
                                            "I need your help with something when you're free",
                                            "Just finished that task we discussed",
                                            "Great work on the presentation yesterday!"
                                        ];
                                    }
                                } else if (this.activeChat.name === "Harsha") {
                                    // Enhanced contextual responses for Harsha based on message content analysis
                                    if (lastMessageText.includes("project") || lastMessageText.includes("discuss")) {
                                        if (lastMessageText.includes("deadline") || lastMessageText.includes("timeline")) {
                                            contextualResponses = [
                                                "Based on our current progress, I think we can meet the deadline if we prioritize the core features.",
                                                "I've updated the project timeline with the latest estimates. We should be able to deliver by the end of next month.",
                                                "We might need to adjust the timeline. Can we discuss the critical path items in our next meeting?"
                                            ];
                                        } else if (lastMessageText.includes("status") || lastMessageText.includes("update")) {
                                            contextualResponses = [
                                                "Just finished the authentication module. Moving on to the user profile features next.",
                                                "Here's a quick update: backend APIs are 80% complete, frontend is about 60% done. Any blockers on your end?",
                                                "Made good progress today - fixed those bugs we discussed and improved the performance on the dashboard page."
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "Yes, I'd be happy to discuss the project details. When are you free?",
                                                "I've been working on the project requirements. I think we should prioritize the user authentication feature.",
                                                "I have some ideas for the project that I'd like to share with you. Can we meet tomorrow?"
                                            ];
                                        }
                                    } else if (lastMessageText.includes("mockup") || lastMessageText.includes("design")) {
                                        if (lastMessageText.includes("feedback") || lastMessageText.includes("review")) {
                                            contextualResponses = [
                                                "I've reviewed the mockups and have some suggestions for improving the user flow. Want to discuss them?",
                                                "Your designs look great! Just a few minor suggestions on the color palette and spacing for better accessibility.",
                                                "The mockups are heading in the right direction. The navigation could be more intuitive though."
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "I've completed the mockups and will share them with you in a moment.",
                                                "The new design looks much better. I think the users will love it.",
                                                "I'd like your feedback on the homepage mockup specifically."
                                            ];
                                        }
                                    } else if (lastMessageText.includes("meeting") || lastMessageText.includes("review")) {
                                        if (lastMessageText.includes("reschedule") || lastMessageText.includes("postpone")) {
                                            contextualResponses = [
                                                "No problem, we can reschedule. How about Friday at the same time?",
                                                "Sure, let's move the meeting. I have availability later this week or early next week.",
                                                "That works for me. Just let me know what time works better for you."
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "I'm available for a review meeting tomorrow morning.",
                                                "Let's schedule the review for 2 PM today if you're free.",
                                                "I'll prepare all the materials for our review session."
                                            ];
                                        }
                                    } else if (lastMessageText.includes("feature") || lastMessageText.includes("implement")) {
                                        if (lastMessageText.includes("priority") || lastMessageText.includes("important")) {
                                            contextualResponses = [
                                                "Based on user feedback, I think the search functionality should be our top priority.",
                                                "I've analyzed the requirements and suggest we prioritize the payment integration first, then move to the social features.",
                                                "The most important features for the MVP are user authentication, basic CRUD operations, and the dashboard. We can add the rest later."
                                            ];
                                        } else {
                                            contextualResponses = [
                                                "I think we should focus on implementing the core features first.",
                                                "The new feature you suggested would take about two weeks to implement.",
                                                "I've already started implementing the messaging feature you requested."
                                            ];
                                        }
                                    } else if (lastMessageText.includes("bug") || lastMessageText.includes("issue")) {
                                        contextualResponses = [
                                            "I've identified the root cause of that bug. It's related to the way we're handling async state updates.",
                                            "Just fixed the issue you reported. It was a race condition in the data loading process.",
                                            "I'm working on that bug now. Should have a fix by end of day."
                                        ];
                                    } else if (lastMessageText.includes("api") || lastMessageText.includes("endpoint")) {
                                        contextualResponses = [
                                            "The API documentation is updated with all the new endpoints we discussed.",
                                            "I've implemented the new API endpoints. They're ready for testing on the dev server.",
                                            "There's an issue with the user profile endpoint. I'm debugging it now."
                                        ];
                                    } else if (contextualResponses.length === 0) {
                                        contextualResponses = [
                                            "Yes, let's discuss the project details",
                                            "I have some great ideas for the upcoming release",
                                            "When is a good time to meet?",
                                            "I've prepared some design mockups to show you",
                                            "How does tomorrow sound for a quick review?",
                                            "Just finished the documentation you requested",
                                            "The project timeline looks good to me",
                                            "I think we should focus on the core features first"
                                        ];
                                    }
                                } else {
                                    // If no specific contextual responses were found, use generic ones
                                    if (contextualResponses.length === 0) {
                                        contextualResponses = [
                                            "Hi there! Nice to hear from you!",
                                            "Thanks for your message!",
                                            "What's up?",
                                            "How are you doing today?",
                                            "Good to see your message",
                                            "Let's catch up soon!",
                                            "I'll get back to you on that",
                                            "That sounds interesting"
                                        ];
                                    }
                                }
                                
                                // Select a random response from the contextual responses
                                const randomResponse = contextualResponses[Math.floor(Math.random() * contextualResponses.length)];
                                console.log("Selected contextual response:", randomResponse);
                                
                                // Add to database
                                const message = this.db.sendMessage(this.activeChat.id, this.currentUser.id, randomResponse);
                                
                                // Add to UI
                                this.addMessageToUI(randomResponse, false, this.formatTime(message.timestamp), message.id);
                                
                                // Update chat memory with friend's response
                                this.updateChatMemory(this.activeChat.id, randomResponse, false);
                                
                                // Move this chat to the top of the chat list when receiving a new message
                                this.moveChatToTop(this.activeChat.name);
                                
                                // Play message received notification sound
                                playNotificationSound('received');
                                
                                // Add unread badge if the user is not actively viewing this chat
                                const activeChatItem = document.querySelector(`.chat-item[data-user="${this.activeChat.name}"]`);
                                if (activeChatItem && document.visibilityState === 'hidden') {
                                    let unreadBadge = activeChatItem.querySelector('.unread-badge');
                                    if (!unreadBadge) {
                                        unreadBadge = document.createElement('div');
                                        unreadBadge.className = 'unread-badge';
                                        unreadBadge.textContent = '1';
                                        activeChatItem.appendChild(unreadBadge);
                                    } else {
                                        const currentCount = parseInt(unreadBadge.textContent);
                                        unreadBadge.textContent = currentCount + 1;
                                    }
                                }
                            }
                        }, 2000);
                    }, 1000);
                }
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp);
                // Convert to IST (UTC+5:30)
                const options = {
                    timeZone: 'Asia/Kolkata',
                    hour12: true,
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return new Intl.DateTimeFormat('en-IN', options).format(date);
            }
            
            analyzeMessageType(message) {
                // If message is empty, return default
                if (!message) return 'statement';
                
                message = message.toLowerCase().trim();
                
                // Check if it's a question
                if (message.includes('?') || 
                    message.startsWith('what') || 
                    message.startsWith('how') || 
                    message.startsWith('when') || 
                    message.startsWith('where') || 
                    message.startsWith('why') || 
                    message.startsWith('who') || 
                    message.startsWith('can') || 
                    message.startsWith('could') || 
                    message.startsWith('would') || 
                    message.startsWith('will') || 
                    message.startsWith('should') || 
                    message.startsWith('is') || 
                    message.startsWith('are') || 
                    message.startsWith('do') || 
                    message.startsWith('did')) {
                    return 'question';
                }
                
                // Check if it's a greeting
                const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'greetings'];
                for (const greeting of greetings) {
                    if (message.includes(greeting)) {
                        return 'greeting';
                    }
                }
                
                // Check if it's a farewell
                const farewells = ['bye', 'goodbye', 'see you', 'talk to you later', 'ttyl', 'later', 'cya'];
                for (const farewell of farewells) {
                    if (message.includes(farewell)) {
                        return 'farewell';
                    }
                }
                
                // Check if it's a thank you message
                const thankYous = ['thanks', 'thank you', 'appreciate', 'grateful', 'thx'];
                for (const thankYou of thankYous) {
                    if (message.includes(thankYou)) {
                        return 'gratitude';
                    }
                }
                
                // Check if it's about a meeting or appointment
                const meetingWords = ['meeting', 'appointment', 'schedule', 'calendar', 'meet', 'sync', 'discuss'];
                for (const word of meetingWords) {
                    if (message.includes(word)) {
                        return 'meeting';
                    }
                }
                
                // Check if it's about a project or work
                const workWords = ['project', 'task', 'deadline', 'work', 'assignment', 'status', 'update'];
                for (const word of workWords) {
                    if (message.includes(word)) {
                        return 'work';
                    }
                }
                
                // Default to statement if no specific type is detected
                return 'statement';
            }
            
            // Update message memory for context-aware responses
            updateChatMemory(chatId, messageText, isFromUser) {
                console.log("Updating chat memory for:", chatId, messageText, isFromUser);
                
                // Ensure chatId is valid
                if (!chatId) {
                    console.error("Invalid chatId in updateChatMemory:", chatId);
                    return;
                }
                
                // Initialize chat memory object if it doesn't exist
                if (!this.chatMemory) {
                    console.log("Initializing chat memory object");
                    this.chatMemory = {};
                }
                
                // Initialize chat memory for this chat if it doesn't exist
                if (!this.chatMemory[chatId]) {
                    console.log("Creating new chat memory for chat ID:", chatId);
                    this.chatMemory[chatId] = {
                        recentMessages: [],
                        topics: {},
                        lastMessageType: null
                    };
                }
                
                const memory = this.chatMemory[chatId];
                
                // Add message to recent messages (keep last 10)
                memory.recentMessages.push({
                    text: messageText,
                    isFromUser: isFromUser,
                    timestamp: Date.now()
                });
                
                if (memory.recentMessages.length > 10) {
                    memory.recentMessages.shift();
                }
                
                // Update topics
                const messageType = this.analyzeMessageType(messageText);
                memory.lastMessageType = messageType;
                
                // Extract keywords and update topics
                const keywords = this.extractKeywords(messageText);
                keywords.forEach(keyword => {
                    if (!memory.topics[keyword]) {
                        memory.topics[keyword] = 1;
                    } else {
                        memory.topics[keyword]++;
                    }
                });
                
                console.log(`Updated chat memory for chat ${chatId}:`, memory);
            }
            
            // Extract keywords from message
            extractKeywords(message) {
                const keywords = [];
                
                // Skip if message is empty
                if (!message) return keywords;
                
                // Convert to lowercase and split into words
                const words = message.toLowerCase().split(/\s+/);
                
                // Common words to ignore
                const stopWords = new Set([
                    'a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'with',
                    'about', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has',
                    'had', 'do', 'does', 'did', 'of', 'it', 'its', 'this', 'that', 'these', 'those'
                ]);
                
                // Filter out stop words and short words
                words.forEach(word => {
                    // Remove punctuation
                    word = word.replace(/[.,!?;:'"()[\]{}]/g, '');
                    
                    if (word.length > 2 && !stopWords.has(word)) {
                        keywords.push(word);
                    }
                });
                
                return keywords;
            }
            
            // Get contextually relevant response based on chat memory
            getContextualResponseFromMemory(chatId, messageType) {
                console.log("Getting contextual response for:", chatId, messageType);
                
                // Safety checks
                if (!this.chatMemory) {
                    console.error("Chat memory object doesn't exist!");
                    return null;
                }
                
                if (!chatId) {
                    console.error("Invalid chatId in getContextualResponseFromMemory");
                    return null;
                }
                
                if (!this.chatMemory[chatId]) {
                    console.log("No chat memory exists for this chat:", chatId);
                    return null;
                }
                
                const memory = this.chatMemory[chatId];
                
                // Sort topics by frequency to find most discussed topics
                const topTopics = Object.entries(memory.topics)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(entry => entry[0]);
                    
                console.log(`Top topics for chat ${chatId}:`, topTopics);
                
                // If there are previous messages, use them for context
                if (memory.recentMessages.length > 0) {
                    // Generate a follow-up question or response based on topics
                    if (topTopics.length > 0) {
                        const topic = topTopics[0];
                        
                        // For questions, try to answer based on topics
                        if (messageType === 'question') {
                            if (topic === 'project') {
                                return "Based on our project discussion, I think we should focus on the core features first.";
                            } else if (topic === 'meeting') {
                                return "Regarding our meeting, I'm available tomorrow afternoon if that works for you.";
                            } else if (topic === 'design' || topic === 'mockup') {
                                return "About the design, I'll share the updated mockups with you by end of day.";
                            }
                        }
                        
                        // For statements, acknowledge and build on the topic
                        if (messageType === 'statement') {
                            return `I see what you mean about the ${topic}. Let's discuss this further.`;
                        }
                    }
                }
                
                return null;
            }
            
            formatMessageContent(text) {
                // This function formats message text, adds hyperlinks, etc.
                // For now, just return the text as-is
                return text;
            }
            
            // Helper method to truncate long texts for previews
            truncateText(text, maxLength) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength - 3) + '...';
            }
            
            scrollToBottom() {
                this.messagesArea.scrollTop = this.messagesArea.scrollHeight;
            }
            
            updateActiveChatInSidebar() {
                if (!this.activeChat) return;
                
                // Remove active class from all chat items
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Find the chat item that matches the active chat and set it as active
                const chatItems = document.querySelectorAll('.chat-item');
                for (let i = 0; i < chatItems.length; i++) {
                    const userName = chatItems[i].getAttribute('data-user');
                    if (userName === this.activeChat.name) {
                        chatItems[i].classList.add('active');
                        break;
                    }
                }
                
                // Update chat header with active chat info
                this.updateChatHeader(this.activeChat.name, this.activeChat.avatar, this.activeChat.status);
            }
            
            simulateFriendActivity() {
                // Periodically change online status of friends to simulate real activity
                setInterval(() => {
                    if (!this.activeChat) return;
                    
                    // Random activity simulation
                    const random = Math.random();
                    
                    if (random > 0.8) {
                        // 20% chance - Change online/offline status
                        const newStatus = this.activeChat.status === 'online' ? 'offline' : 'online';
                        
                        // Update in database
                        this.activeChat = this.db.updateUserStatus(this.activeChat.id, newStatus === 'online');
                        
                        // Update UI
                        this.updateChatHeader(this.activeChat.name, this.activeChat.avatar, this.activeChat.status);
                        
                        // Update online indicator in chat list
                        const chatItem = document.querySelector(`.chat-item[data-user="${this.activeChat.name}"]`);
                        if (chatItem) {
                            const onlineIndicator = chatItem.querySelector('.online-indicator');
                            if (onlineIndicator) {
                                if (newStatus === 'online') {
                                    onlineIndicator.style.display = 'block';
                                } else {
                                    onlineIndicator.style.display = 'none';
                                }
                            }
                        }
                    } 
                    else if (random > 0.6 && this.activeChat.status === 'online') {
                        // 20% chance - Simulate friend typing/being active (only if already online)
                        this.activeChat = this.db.updateUserActivity(this.activeChat.id);
                        this.updateChatHeader(this.activeChat.name, this.activeChat.avatar, this.activeChat.status);
                        
                        // Show typing indicator sometimes when they're active
                        if (Math.random() > 0.5) {
                            this.simulateTypingIndicator(true); // Force typing simulation
                        }
                    }
                }, 30000); // Check every 30 seconds
                
                // Update status display periodically to reflect changes in "active now" vs "online"
                setInterval(() => {
                    if (this.activeChat && this.activeChat.status === 'online') {
                        this.updateChatHeader(this.activeChat.name, this.activeChat.avatar, this.activeChat.status);
                    }
                }, 10000);
            }
        }
        
        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Set to false to keep messages permanently stored in localStorage
            const shouldReset = false; // Changed to false to make messages persist
            if (shouldReset) {
                console.log("Resetting chat database...");
                localStorage.removeItem('wechat_users');
                localStorage.removeItem('wechat_conversations');
                localStorage.removeItem('wechat_groups');
                localStorage.removeItem('wechat_group_conversations');
            }
            
            // Initialize database structure if it doesn't exist
            if (!localStorage.getItem('wechat_users')) {
                console.log("Creating initial database structure...");
                // The ChatUI constructor will create the database structure
            }
            
            const chatUI = new ChatUI();
            console.log("Chat UI initialized");
            
            // Add Harsha to sidebar and ensure conversation exists
            const harsha = chatUI.db.getUserByName('Harsha');
            console.log("Found Harsha:", harsha);
            
            if (harsha) {
                // Make sure a conversation exists between current user and Harsha
                const currentUser = chatUI.db.getCurrentUser();
                console.log("Current user:", currentUser);
                
                const conversationKey = chatUI.db.getConversationKey(currentUser.id, harsha.id);
                console.log("Conversation key:", conversationKey);
                
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                
                // Always update the conversation to ensure it has messages
                conversations[conversationKey] = {
                    participants: [currentUser.id, harsha.id],
                    messages: [
                        {
                            id: Date.now() - 1800000,
                            senderId: harsha.id,
                            text: 'Hi, can we discuss the project?',
                            timestamp: new Date(Date.now() - 1800000).toISOString(),
                            status: 'read'
                        }
                    ]
                };
                localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                console.log("Conversation saved:", conversations[conversationKey]);
                
                // Manually add Harsha to sidebar
                chatUI.addFriendToSidebar(harsha);
                console.log("Harsha added to sidebar");
            }
            
            // Add Badri to sidebar and ensure conversation exists
            const badri = chatUI.db.getUserByName('Badri');
            console.log("Found Badri:", badri);
            
            if (badri) {
                const currentUser = chatUI.db.getCurrentUser();
                const conversationKey = chatUI.db.getConversationKey(currentUser.id, badri.id);
                console.log("Badri conversation key:", conversationKey);
                
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                
                // Create conversation with Badri if it doesn't exist
                conversations[conversationKey] = {
                    participants: [currentUser.id, badri.id],
                    messages: [
                        {
                            id: Date.now() - 3600000,
                            senderId: badri.id,
                            text: 'Hey, how are you doing today?',
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            status: 'read'
                        },
                        {
                            id: Date.now() - 3500000,
                            senderId: currentUser.id,
                            text: 'I\'m good, thanks! How about you?',
                            timestamp: new Date(Date.now() - 3500000).toISOString(),
                            status: 'read'
                        }
                    ]
                };
                localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                console.log("Badri conversation saved:", conversations[conversationKey]);
                
                // Add Badri to sidebar
                chatUI.addFriendToSidebar(badri);
                console.log("Badri added to sidebar");
            }
            
            // Add Anushka to the users database if she doesn't exist
            let anushka = chatUI.db.getUserByName('Anushka');
            if (!anushka) {
                // First, get all existing users
                const users = JSON.parse(localStorage.getItem('wechat_users')) || [];
                // Add Anushka with the next available ID
                const nextId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                anushka = {
                    id: nextId,
                    name: 'Anushka',
                    handle: '@anushka',
                    avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b4ab?w=150&h=150&fit=crop&crop=face',
                    status: 'online'
                };
                users.push(anushka);
                localStorage.setItem('wechat_users', JSON.stringify(users));
                console.log("Added Anushka to users database:", anushka);
            }
            
            // Create conversation with Anushka
            if (anushka) {
                const currentUser = chatUI.db.getCurrentUser();
                const conversationKey = chatUI.db.getConversationKey(currentUser.id, anushka.id);
                console.log("Anushka conversation key:", conversationKey);
                
                const conversations = JSON.parse(localStorage.getItem('wechat_conversations')) || {};
                
                // Create conversation with Anushka
                conversations[conversationKey] = {
                    participants: [currentUser.id, anushka.id],
                    messages: [
                        {
                            id: Date.now() - 2800000,
                            senderId: anushka.id,
                            text: 'Hi there! How is your project going?',
                            timestamp: new Date(Date.now() - 2800000).toISOString(),
                            status: 'read'
                        },
                        {
                            id: Date.now() - 2700000,
                            senderId: currentUser.id,
                            text: 'Hi Anushka! It\'s coming along well, thanks for asking.',
                            timestamp: new Date(Date.now() - 2700000).toISOString(),
                            status: 'read'
                        }
                    ]
                };
                localStorage.setItem('wechat_conversations', JSON.stringify(conversations));
                console.log("Anushka conversation saved:", conversations[conversationKey]);
                
                // Add Anushka to sidebar
                chatUI.addFriendToSidebar(anushka);
                console.log("Anushka added to sidebar");
            }
                
            // Force a reload of chat handlers to ensure they work
            setTimeout(() => {
                chatUI.setupChatItemListeners();
                console.log("Chat item listeners refreshed");
                
                // Add click event listener to chat-with-name for profile/group options
                const chatWithName = document.getElementById('chat-with-name');
                if (chatWithName) {
                    chatWithName.addEventListener('click', () => {
                        if (chatUI.activeChat) {
                            if (chatUI.isGroupChat) {
                                // Open group info modal for group chats
                                console.log('Opening group info for:', chatUI.activeChat.name);
                                chatUI.openGroupInfoModal();
                            } else {
                                // Open friend profile for personal chats
                                const friendName = chatUI.activeChat.name;
                                const profileUrl = `profile.html?friend=${encodeURIComponent(friendName)}`;
                                console.log('Opening profile for:', friendName);
                                window.location.href = profileUrl;
                            }
                        }
                    });
                    
                    // Add dynamic title attribute based on chat type
                    const updateChatNameTitle = () => {
                        if (chatUI.isGroupChat) {
                            chatWithName.title = 'Click to view group info and settings';
                        } else {
                            chatWithName.title = 'Click to view profile';
                        }
                    };
                    
                    // Set initial title
                    updateChatNameTitle();
                    
                    // Update title when chat changes (we'll need to call this when switching chats)
                    chatUI.updateChatNameTitle = updateChatNameTitle;
                    
                    console.log("Profile/Group click listener added to chat name");
                }
                
                // Add click event listener to current user profile (excluding logout button)
                const userInfo = document.querySelector('.user-info');
                if (userInfo) {
                    userInfo.addEventListener('click', () => {
                        const currentUserName = chatUI.currentUser.name;
                        const profileUrl = `profile.html?currentUser=true&name=${encodeURIComponent(currentUserName)}`;
                        console.log('Opening current user profile for:', currentUserName);
                        window.location.href = profileUrl;
                    });
                    console.log("Profile click listener added to current user info");
                }
                
                // Add logout functionality
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent user profile click
                        
                        if (confirm('Are you sure you want to logout?')) {
                            // Clear user session data (optional - keep chat history)
                            console.log('User logged out');
                            
                            // Show logout confirmation
                            const notification = document.createElement('div');
                            notification.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #4CAF50;
                                color: white;
                                padding: 15px 20px;
                                border-radius: 8px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                z-index: 10000;
                                font-weight: 500;
                                animation: slideIn 0.3s ease;
                            `;
                            notification.innerHTML = '<i class="fas fa-check-circle"></i> Successfully logged out!';
                            document.body.appendChild(notification);
                            
                            // Add animation keyframes if not already present
                            if (!document.querySelector('#logout-animation')) {
                                const style = document.createElement('style');
                                style.id = 'logout-animation';
                                style.textContent = `
                                    @keyframes slideIn {
                                        from { transform: translateX(100%); opacity: 0; }
                                        to { transform: translateX(0); opacity: 1; }
                                    }
                                `;
                                document.head.appendChild(style);
                            }
                            
                            // Redirect to login page or home after a short delay
                            setTimeout(() => {
                                notification.remove();
                                // You can redirect to a login page here
                                // For demo purposes, we'll just reload the page
                                window.location.reload();
                            }, 2000);
                        }
                    });
                    console.log("Logout click listener added");
                }
                
                // Add menu dropdown functionality
                const menuBtn = document.getElementById('menu-btn');
                const userMenu = document.getElementById('user-menu');
                
                if (menuBtn && userMenu) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userMenu.classList.toggle('show');
                        console.log("Menu toggled");
                    });
                    
                    // Close menu when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                            userMenu.classList.remove('show');
                        }
                    });
                    
                    // Menu item click handlers
                    document.getElementById('settings-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        showNotification('Opening Settings...', '#2196F3');
                        // You can redirect to settings page here
                        console.log('Settings clicked');
                    });
                    
                    document.getElementById('theme-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        toggleTheme();
                    });
                    
                    document.getElementById('notifications-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        const notificationToggle = document.getElementById('notification-toggle');
                        if (notificationToggle) {
                            notificationToggle.click(); // Trigger existing notification toggle
                        }
                    });
                    
                    document.getElementById('privacy-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        showNotification('Privacy settings coming soon...', '#9C27B0');
                        console.log('Privacy clicked');
                    });
                    
                    document.getElementById('help-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        showNotification('Help & Support: Contact us at support@wechat.com', '#4CAF50');
                        console.log('Help clicked');
                    });
                    
                    document.getElementById('about-menu')?.addEventListener('click', () => {
                        userMenu.classList.remove('show');
                        showAboutModal();
                        console.log('About clicked');
                    });
                    
                    console.log("Menu functionality added");
                }
            }, 500);
            
            // Initialize notification settings
            if (localStorage.getItem('notifications_enabled') === null) {
                localStorage.setItem('notifications_enabled', 'true');
            }
            
            // Request permission for notifications in browsers that require it
            if (typeof Notification !== 'undefined' && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            
            // Update notification toggle appearance based on saved setting
            const notificationToggle = document.getElementById('notification-toggle');
            if (localStorage.getItem('notifications_enabled') === 'false') {
                notificationToggle.classList.remove('active');
                notificationToggle.querySelector('i').className = 'fas fa-bell-slash';
            } else {
                notificationToggle.classList.add('active');
                notificationToggle.querySelector('i').className = 'fas fa-bell';
            }
            
            // Add notification toggle event listener
            notificationToggle.addEventListener('click', () => {
                const isEnabled = localStorage.getItem('notifications_enabled') !== 'false';
                
                // Toggle setting
                localStorage.setItem('notifications_enabled', isEnabled ? 'false' : 'true');
                
                // Update UI
                if (isEnabled) {
                    notificationToggle.classList.remove('active');
                    notificationToggle.querySelector('i').className = 'fas fa-bell-slash';
                } else {
                    notificationToggle.classList.add('active');
                    notificationToggle.querySelector('i').className = 'fas fa-bell';
                    
                    // Play a sound to demonstrate notifications are now enabled
                    playNotificationSound('received');
                }
            });
            
            // Group-related event handlers are handled by ChatUI class
            
            // Close Group Modal
            const groupModalClose = document.getElementById('group-modal-close');
            const cancelGroupBtn = document.getElementById('cancel-group-btn');
            
            groupModalClose.addEventListener('click', () => {
                document.getElementById('group-modal').style.display = 'none';
            });
            
            cancelGroupBtn.addEventListener('click', () => {
                document.getElementById('group-modal').style.display = 'none';
            });
            
            // Create Group submit button handled by ChatUI class
            
            // Add member to group
            const addMemberBtn = document.getElementById('add-member-btn');
            addMemberBtn.addEventListener('click', () => {
                const contactSelect = document.getElementById('contact-select');
                const selectedContactId = parseInt(contactSelect.value);
                if (!selectedContactId) return;
                
                // Check if member is already added
                const selectedMembers = document.getElementById('selected-members');
                const existingMember = selectedMembers.querySelector(`.member-item[data-user-id="${selectedContactId}"]`);
                if (existingMember) return;
                
                // Get user details
                const user = chatUI.db.getUserById(selectedContactId);
                if (!user) return;
                
                // Create member item
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.dataset.userId = user.id;
                memberItem.innerHTML = `
                    <img src="${user.avatar}" alt="${user.name}" class="member-avatar">
                    <div class="member-name">${user.name}</div>
                    <button class="member-remove" data-user-id="${user.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add remove functionality
                const removeBtn = memberItem.querySelector('.member-remove');
                removeBtn.addEventListener('click', () => {
                    memberItem.remove();
                });
                
                // Add to selected members
                selectedMembers.appendChild(memberItem);
            });
            
            // Group info button
            const groupInfoBtn = document.getElementById('group-info-btn');
            groupInfoBtn.addEventListener('click', () => {
                chatUI.openGroupInfoModal();
            });
            
            // Close Group Info Modal
            const groupInfoModalClose = document.getElementById('group-info-modal-close');
            const closeGroupInfoBtn = document.getElementById('close-group-info-btn');
            
            groupInfoModalClose.addEventListener('click', () => {
                document.getElementById('group-info-modal').style.display = 'none';
            });
            
            closeGroupInfoBtn.addEventListener('click', () => {
                document.getElementById('group-info-modal').style.display = 'none';
            });
            
            // Leave Group button
            const leaveGroupBtn = document.getElementById('leave-group-btn');
            leaveGroupBtn.addEventListener('click', () => {
                if (chatUI.isGroupChat && chatUI.activeChat) {
                    if (confirm('Are you sure you want to leave this group?')) {
                        chatUI.db.removeMemberFromGroup(chatUI.activeChat.id, chatUI.currentUser.id);
                        document.getElementById('group-info-modal').style.display = 'none';
                        window.location.href = 'message.html';
                    }
                }
            });
            
            // Add member to group in group info modal
            const groupInfoAddMemberBtn = document.getElementById('group-info-add-member-btn');
            groupInfoAddMemberBtn.addEventListener('click', () => {
                const groupInfoContactSelect = document.getElementById('group-info-contact-select');
                const selectedContactId = parseInt(groupInfoContactSelect.value);
                if (selectedContactId && chatUI.isGroupChat && chatUI.activeChat) {
                    chatUI.db.addMemberToGroup(chatUI.activeChat.id, selectedContactId);
                    chatUI.openGroupInfoModal();
                }
            });
            
            // Add member to group in the separate group info modal
            const groupAddMemberBtn = document.getElementById('group-add-member-btn');
            if (groupAddMemberBtn) {
                groupAddMemberBtn.addEventListener('click', () => {
                    const groupContactSelect = document.getElementById('group-contact-select');
                    const selectedContactId = parseInt(groupContactSelect.value);
                    if (selectedContactId && chatUI.isGroupChat && chatUI.activeChat) {
                        chatUI.db.addMemberToGroup(chatUI.activeChat.id, selectedContactId);
                        chatUI.openGroupInfoModal();
                    }
                });
            }
            
            // Add a test sound button
            const testSoundButton = document.createElement('button');
            testSoundButton.id = 'test-sound-button';
            testSoundButton.innerHTML = 'Test Notification Sound';
            testSoundButton.style.position = 'fixed';
            testSoundButton.style.bottom = '20px';
            testSoundButton.style.right = '20px';
            testSoundButton.style.zIndex = '1000';
            testSoundButton.style.padding = '10px 15px';
            testSoundButton.style.backgroundColor = 'var(--primary-color)';
            testSoundButton.style.color = 'white';
            testSoundButton.style.border = 'none';
            testSoundButton.style.borderRadius = '5px';
            testSoundButton.style.cursor = 'pointer';
            testSoundButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            testSoundButton.onclick = function() {
                // Play both sounds with a slight delay between them
                playNotificationSound('sent');
                setTimeout(() => {
                    playNotificationSound('received');
                }, 1000);
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.position = 'fixed';
                successMsg.style.bottom = '70px';
                successMsg.style.right = '20px';
                successMsg.style.backgroundColor = '#4CAF50';
                successMsg.style.color = 'white';
                successMsg.style.padding = '10px';
                successMsg.style.borderRadius = '5px';
                successMsg.style.zIndex = '1000';
                successMsg.innerText = 'Testing notification sounds...';
                document.body.appendChild(successMsg);
                
                // Remove the success message after 3 seconds
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            };
            document.body.appendChild(testSoundButton);
        });
        
        // File attachment and emoji functionality
        let selectedFiles = [];
        
        // File attachment
        document.getElementById('attachment-btn').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = e.target.files;
            if (!files.length) return;
            
            const selectedFilesContainer = document.getElementById('selected-files');
            selectedFilesContainer.style.display = 'flex';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                selectedFiles.push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'selected-file';
                
                const fileType = file.type.split('/')[0];
                let iconClass = 'fas fa-file';
                
                if (fileType === 'image') {
                    iconClass = 'fas fa-image';
                } else if (fileType === 'video') {
                    iconClass = 'fas fa-video';
                } else if (fileType === 'audio') {
                    iconClass = 'fas fa-music';
                } else if (file.name.endsWith('.pdf')) {
                    iconClass = 'fas fa-file-pdf';
                } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                    iconClass = 'fas fa-file-word';
                } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                    iconClass = 'fas fa-file-excel';
                }
                
                fileItem.innerHTML = `
                    <span class="file-icon"><i class="${iconClass}"></i></span>
                    <span class="file-name">${file.name}</span>
                    <span class="remove-file" data-index="${selectedFiles.length - 1}">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                
                selectedFilesContainer.appendChild(fileItem);
            }
            
            // Reset the input so the same file can be selected again
            e.target.value = '';
        });
        
        // Remove file from selected files
        document.addEventListener('click', (e) => {
            if (e.target.closest('.remove-file')) {
                const index = e.target.closest('.remove-file').getAttribute('data-index');
                selectedFiles.splice(index, 1);
                e.target.closest('.selected-file').remove();
                
                // Update indexes for remaining files
                document.querySelectorAll('.remove-file').forEach((el, idx) => {
                    el.setAttribute('data-index', idx);
                });
                
                // Hide container if no files selected
                if (selectedFiles.length === 0) {
                    document.getElementById('selected-files').style.display = 'none';
                }
            }
        });
        
        // Emoji picker
        const emojiPickerBtn = document.getElementById('emoji-picker-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const messageInput = document.getElementById('message-input');
        
        // Create emoji picker
        function createEmojiPicker() {
            // Common emoji categories
            const emojis = {
                smileys: ["😀", "😁", "😂", "🤣", "😃", "😄", "😅", "😆", "😉", "😊", "😋", "😎", "😍", "😘", "🥰", "😗", "😙", "😚", "🙂", "🤗", "🤩", "🤔", "🤨", "😐", "😑", "😶", "🙄", "😏", "😣", "😥", "😮", "🤐", "😯", "😪", "😫", "😴", "😌", "😛", "😜", "😝", "🤤", "😒", "😓", "😔", "😕", "🙃", "🤑", "😲", "☹️", "🙁", "😖", "😞", "😟", "😤", "😢", "😭", "😦", "😧", "😨", "😩", "🤯", "😬", "😰", "😱", "🥵", "🥶", "😳", "🤪", "😵", "😡", "😠", "🤬", "😷", "🤒", "🤕", "🤢", "🤮", "🤧", "😇", "🤠", "🤡", "🥳", "🥴", "🥺", "🤥", "🤫", "🤭", "🧐", "🤓"],
                gestures: ["👋", "🤚", "🖐️", "✋", "🖖", "👌", "✌️", "🤞", "🤟", "🤘", "🤙", "👈", "👉", "👆", "🖕", "👇", "☝️", "👍", "👎", "✊", "👊", "🤛", "🤜", "👏", "🙌", "👐", "🤲", "🤝", "🙏", "💪", "🦵", "🦶", "👂", "👃", "🧠", "🦷", "🦴", "👀", "👁️", "👅", "👄", "💋", "👨‍👩‍👦", "👨‍👩‍👧", "👨‍👩‍👧‍👦", "👨‍👩‍👦‍👦", "👨‍👩‍👧‍👧", "👨‍👨‍👦", "👨‍👨‍👧", "👨‍👨‍👧‍👦", "👨‍👨‍👦‍👦", "👨‍👨‍👧‍👧", "👩‍👩‍👦", "👩‍👩‍👧", "👩‍👩‍👧‍👦", "👩‍👩‍👦‍👦", "👩‍👩‍👧‍👧"],
                animals: ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🦝", "🐻", "🐼", "🦘", "🦡", "🐨", "🐯", "🦁", "🐮", "🐷", "🐽", "🐸", "🐵", "🙈", "🙉", "🙊", "🐒", "🐔", "🐧", "🐦", "🐤", "🐣", "🐥", "🦆", "🦢", "🦉", "🦚", "🦜", "🦇", "🐺", "🐗", "🐴", "🦄", "🐝", "🐛", "🦋", "🐌", "🐚", "🐞", "🐜", "🦗", "🕷️", "🕸️", "🦂", "🦟", "🦠", "🐢", "🐍", "🦎", "🦖", "🦕", "🐙", "🦑", "🦐", "🦞", "🦀", "🐡", "🐠", "🐟", "🐬", "🐳", "🐋", "🦈", "🐊", "🐅", "🐆", "🦓", "🦍", "🐘", "🦏", "🦛", "🐪", "🐫", "🦙", "🦒", "🐃", "🐂", "🐄", "🐎", "🐖", "🐏", "🐑", "🐐", "🦌", "🐕", "🐩", "🐈", "🐓", "🦃", "🕊️", "🐇", "🐁", "🐀", "🐿️", "🦔", "🐾", "🐉", "🐲", "🌵", "🎄", "🌲", "🌳", "🌴", "🌱", "🌿", "☘️", "🍀", "🎍", "🎋", "🍃", "🍂", "🍁", "🍄", "🌾", "💐", "🌷", "🌹", "🥀", "🌺", "🌸", "🌼", "🌻"],
                food: ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🍍", "🥭", "🥥", "🥝", "🍅", "🍆", "🥑", "🥦", "🥒", "🥬", "🌶️", "🌽", "🥕", "🥔", "🍠", "🥐", "🍞", "🥖", "🥨", "🥯", "🧀", "🥚", "🍳", "🥞", "🥓", "🥩", "🍗", "🍖", "🌭", "🍔", "🍟", "🍕", "🥪", "🥙", "🌮", "🌯", "🥗", "🥘", "🥫", "🍝", "🍜", "🍲", "🍛", "🍣", "🍱", "🥟", "🍤", "🍙", "🍚", "🍘", "🍥", "🥮", "🥠", "🍢", "🍡", "🍧", "🍨", "🍦", "🥧", "🍰", "🧁", "🎂", "🍮", "🍭", "🍬", "🍫", "🍿", "🧂", "🍩", "🍪", "🌰", "🥜", "🍯", "🥛", "🍼", "☕", "🍵", "🥤", "🍶", "🍺", "🍻", "🥂", "🍷", "🥃", "🍸", "🍹", "🍾", "🥄", "🍴", "🍽️", "🥣", "🥡", "🥢"],
                activity: ["⚽", "🏀", "🏈", "⚾", "🥎", "🏐", "🏉", "🎱", "🏓", "🏸", "🥅", "🏒", "🏑", "🥍", "🏏", "⛳", "🏹", "🎣", "🥊", "🥋", "🎽", "⛸️", "🥌", "🛷", "🛹", "🎿", "⛷️", "🏂", "🏋️‍♀️", "🏋️‍♂️", "🤼‍♀️", "🤼‍♂️", "🤸‍♀️", "🤸‍♂️", "⛹️‍♀️", "⛹️‍♂️", "🤺", "🤾‍♀️", "🤾‍♂️", "🏌️‍♀️", "🏌️‍♂️", "🏇", "🧘‍♀️", "🧘‍♂️", "🏄‍♀️", "🏄‍♂️", "🏊‍♀️", "🏊‍♂️", "🤽‍♀️", "🤽‍♂️", "🚣‍♀️", "🚣‍♂️", "🧗‍♀️", "🧗‍♂️", "🚵‍♀️", "🚵‍♂️", "🚴‍♀️", "🚴‍♂️", "🏆", "🥇", "🥈", "🥉", "🏅", "🎖️", "🏵️", "🎗️", "🎫", "🎟️", "🎪", "🤹‍♀️", "🤹‍♂️", "🎭", "🎨", "🎬", "🎤", "🎧", "🎼", "🎹", "🥁", "🎷", "🎺", "🎸", "🎻", "🎲", "🧩", "♟️", "🎯", "🎳", "🎮", "🎰"],
                travel: ["🚗", "🚕", "🚙", "🚌", "🚎", "🏎️", "🚓", "🚑", "🚒", "🚐", "🚚", "🚛", "🚜", "🛴", "🚲", "🛵", "🏍️", "🚨", "🚔", "🚍", "🚘", "🚖", "🚡", "🚠", "🚟", "🚃", "🚋", "🚞", "🚝", "🚄", "🚅", "🚈", "🚂", "🚆", "🚇", "🚊", "🚉", "✈️", "🛫", "🛬", "🛩️", "💺", "🛰️", "🚀", "🛸", "🚁", "🛶", "⛵", "🚤", "🛥️", "🛳️", "⛴️", "🚢", "⚓", "⛽", "🚧", "🚦", "🚥", "🚏", "🗺️", "🗿", "🗽", "🗼", "🏰", "🏯", "🏟️", "🎡", "🎢", "🎠", "⛲", "⛱️", "🏖️", "🏝️", "🏜️", "🌋", "⛰️", "🏔️", "🗻", "🏕️", "⛺", "🏠", "🏡", "🏘️", "🏚️", "🏗️", "🏭", "🏢", "🏬", "🏣", "🏤", "🏥", "🏦", "🏨", "🏪", "🏫", "🏩", "💒", "🏛️", "⛪", "🕌", "🕍", "🕋", "⛩️", "🛤️", "🛣️", "🗾", "🎑", "🏞️", "🌅", "🌄", "🌠", "🎇", "🎆", "🌇", "🌆", "🏙️", "🌃", "🌌", "🌉", "🌁"]
            };
            
            // Build emoji picker UI
            emojiPicker.innerHTML = `
                <div class="emoji-picker-header">
                    <div class="emoji-category">
                        <button class="emoji-category-btn active" data-category="smileys">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="emoji-category-btn" data-category="gestures">
                            <i class="far fa-hand-peace"></i>
                        </button>
                        <button class="emoji-category-btn" data-category="animals">
                            <i class="fas fa-paw"></i>
                        </button>
                        <button class="emoji-category-btn" data-category="food">
                            <i class="fas fa-pizza-slice"></i>
                        </button>
                        <button class="emoji-category-btn" data-category="activity">
                            <i class="fas fa-futbol"></i>
                        </button>
                        <button class="emoji-category-btn" data-category="travel">
                            <i class="fas fa-plane"></i>
                        </button>
                    </div>
                </div>
                <input type="text" class="emoji-search" placeholder="Search emoji...">
                <div class="emoji-content" id="emoji-content"></div>
            `;
            
            // Show smileys by default
            showEmojiCategory('smileys');
            
            // Set up category switching
            const categoryBtns = emojiPicker.querySelectorAll('.emoji-category-btn');
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const category = btn.getAttribute('data-category');
                    showEmojiCategory(category);
                });
            });
            
            // Set up emoji search
            const searchInput = emojiPicker.querySelector('.emoji-search');
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const allEmojis = [...Object.values(emojis)].flat();
                
                if (!searchTerm) {
                    showEmojiCategory('smileys');
                    return;
                }
                
                const emojiContent = document.getElementById('emoji-content');
                emojiContent.innerHTML = '';
                
                allEmojis.forEach(emoji => {
                    const emojiEl = document.createElement('div');
                    emojiEl.className = 'emoji';
                    emojiEl.textContent = emoji;
                    emojiEl.addEventListener('click', () => {
                        insertEmoji(emoji);
                    });
                    emojiContent.appendChild(emojiEl);
                });
            });
            
            function showEmojiCategory(category) {
                const emojiContent = document.getElementById('emoji-content');
                emojiContent.innerHTML = '';
                
                emojis[category].forEach(emoji => {
                    const emojiEl = document.createElement('div');
                    emojiEl.className = 'emoji';
                    emojiEl.textContent = emoji;
                    emojiEl.addEventListener('click', () => {
                        insertEmoji(emoji);
                    });
                    emojiContent.appendChild(emojiEl);
                });
            }
            
            function insertEmoji(emoji) {
                // Get current cursor position
                const start = messageInput.selectionStart;
                const end = messageInput.selectionEnd;
                const text = messageInput.value;
                
                // Insert emoji at cursor position
                messageInput.value = text.substring(0, start) + emoji + text.substring(end);
                
                // Move cursor after inserted emoji
                messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
                
                // Focus back on input
                messageInput.focus();
            }
        }
        
        // Show/hide emoji picker
        emojiPickerBtn.addEventListener('click', () => {
            if (emojiPicker.style.display === 'flex') {
                emojiPicker.style.display = 'none';
            } else {
                // Create emoji picker if not already created
                if (!emojiPicker.innerHTML) {
                    createEmojiPicker();
                }
                emojiPicker.style.display = 'flex';
            }
        });
        
        // Hide emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#emoji-picker') && !e.target.closest('#emoji-picker-btn') && emojiPicker.style.display === 'flex') {
                emojiPicker.style.display = 'none';
            }
        });
        
        // Modify sendMessage method to include file attachments
        const originalSendMessage = ChatUI.prototype.sendMessage;
        
        ChatUI.prototype.sendMessage = function() {
            const text = this.messageInput.value.trim();
            
            // Handle files first
            if (selectedFiles.length > 0) {
                for (const file of selectedFiles) {
                    const fileType = file.type.split('/')[0];
                    const fileMessage = document.createElement('div');
                    fileMessage.className = 'message message-sent file-message';
                    
                    let fileContent = '';
                    let iconClass = 'fas fa-file';
                    
                    if (fileType === 'image') {
                        // Create image preview
                        iconClass = 'fas fa-image';
                        const imgUrl = URL.createObjectURL(file);
                        fileContent = `<img src="${imgUrl}" alt="${file.name}" class="file-preview"><br>`;
                    } else if (fileType === 'video') {
                        iconClass = 'fas fa-video';
                    } else if (fileType === 'audio') {
                        iconClass = 'fas fa-music';
                    } else if (file.name.endsWith('.pdf')) {
                        iconClass = 'fas fa-file-pdf';
                    } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                        iconClass = 'fas fa-file-word';
                    } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                        iconClass = 'fas fa-file-excel';
                    }
                    
                    const fileLinkHtml = `
                        <a href="#" class="file-link" title="${file.name}">
                            <i class="${iconClass}"></i>
                            <span>${file.name}</span>
                        </a>
                    `;
                    
                    fileContent += fileLinkHtml;
                    
                    const messageTime = document.createElement('div');
                    messageTime.className = 'message-time';
                    messageTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const messageStatus = document.createElement('span');
                    messageStatus.className = 'message-status';
                    messageStatus.innerHTML = '<i class="fas fa-check-double"></i>';
                    messageTime.appendChild(messageStatus);
                    
                    fileMessage.innerHTML = `<div class="message-content">${fileContent}</div>`;
                    fileMessage.appendChild(messageTime);
                    
                    this.messagesArea.appendChild(fileMessage);
                }
                
                // Clear selected files
                selectedFiles = [];
                document.getElementById('selected-files').innerHTML = '';
                document.getElementById('selected-files').style.display = 'none';
                
                // Scroll to bottom
                this.scrollToBottom();
                
                // If there's text, send it as a separate message
                if (text) {
                    originalSendMessage.call(this);
                } else {
                    // Play notification sound for file sent
                    playNotificationSound('sent');
                    
                    // Simulate response if no text
                    this.simulateTypingIndicator();
                }
                
                return;
            }
            
            // If no files, just send the message normally
            if (text) {
                originalSendMessage.call(this);
            }
        };
        
        // Call Interface Functionality
        const audioCallBtn = document.getElementById('audio-call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        let activeCallType = null;
        let callTimer = null;
        let callDuration = 0;
        
        // Audio Call
        audioCallBtn.addEventListener('click', () => {
            initiateCall('audio');
        });
        
        // Video Call
        videoCallBtn.addEventListener('click', () => {
            initiateCall('video');
        });
        
        function initiateCall(type) {
            activeCallType = type;
            const callOverlay = document.getElementById(type === 'audio' ? 'audio-call-overlay' : 'video-call-overlay');
            const friendName = document.getElementById('chat-with-name').textContent;
            const friendAvatar = document.getElementById('chat-with-avatar').src;
            
            // Update call interface with friend's info
            document.querySelectorAll('.call-friend-name').forEach(el => {
                el.textContent = friendName;
            });
            
            document.querySelectorAll('.call-avatar').forEach(el => {
                el.src = friendAvatar;
            });
            
            // Show appropriate overlay
            callOverlay.style.display = 'flex';
            
            // Start call simulation
            simulateCall(type);
        }
        
        function simulateCall(type) {
            const callOverlay = document.getElementById(type === 'audio' ? 'audio-call-overlay' : 'video-call-overlay');
            const statusElement = callOverlay.querySelector('.call-status');
            const timerElement = callOverlay.querySelector('.call-timer');
            
            // Simulate connecting
            statusElement.textContent = 'Connecting...';
            
            // Simulate ringing
            setTimeout(() => {
                statusElement.textContent = 'Ringing...';
                
                // Simulate call pickup after a delay
                setTimeout(() => {
                    statusElement.textContent = 'Connected';
                    
                    // Start call timer
                    callDuration = 0;
                    callTimer = setInterval(() => {
                        callDuration++;
                        const minutes = Math.floor(callDuration / 60).toString().padStart(2, '0');
                        const seconds = (callDuration % 60).toString().padStart(2, '0');
                        timerElement.textContent = `${minutes}:${seconds}`;
                    }, 1000);
                }, 3000);
            }, 2000);
        }
        
        function endCall() {
            // Hide call overlays
            document.getElementById('audio-call-overlay').style.display = 'none';
            document.getElementById('video-call-overlay').style.display = 'none';
            
            // Clear timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            activeCallType = null;
        }
        
        function toggleMic() {
            const micBtn = document.querySelector('.toggle-mic');
            micBtn.classList.toggle('disabled');
            const icon = micBtn.querySelector('i');
            
            if (micBtn.classList.contains('disabled')) {
                icon.className = 'fas fa-microphone-slash';
            } else {
                icon.className = 'fas fa-microphone';
            }
        }
        
        function toggleCamera() {
            const cameraBtn = document.querySelector('.toggle-camera');
            cameraBtn.classList.toggle('disabled');
            const icon = cameraBtn.querySelector('i');
            
            if (cameraBtn.classList.contains('disabled')) {
                icon.className = 'fas fa-video-slash';
            } else {
                icon.className = 'fas fa-video';
            }
        }
        
        // Function to play notification sounds
        function playNotificationSound(type) {
            // Always log for debugging
            console.log('Attempting to play notification sound:', type);
            
            // Check if user allows notifications
            const notificationsEnabled = localStorage.getItem('notifications_enabled') !== 'false';
            
            if (!notificationsEnabled) {
                console.log('Notifications are disabled in settings');
                return;
            }
            
            // ALWAYS play sound for both sent and received messages
            // Remove the focus check to ensure sound plays in all cases
            
            // Get the appropriate sound element
            const sound = document.getElementById(type === 'sent' ? 'message-sent-sound' : 'message-received-sound');
            
            if (!sound) {
                console.error('Sound element not found');
                return;
            }
            
            // Force user interaction to enable audio
            const forceInteraction = function() {
                // Reset audio to start
                sound.pause();
                sound.currentTime = 0;
                
                // Set volume to ensure it's audible
                sound.volume = 1.0;
                
                // Try to play the sound with user interaction
                const promise = sound.play();
                
                if (promise) {
                    promise.then(() => {
                        console.log('Sound played successfully');
                    }).catch(err => {
                        console.error('Error playing sound:', err);
                        // Create a temporary button to enable sound on click
                        if (err.name === 'NotAllowedError' && !document.getElementById('enable-sound-btn')) {
                            const button = document.createElement('button');
                            button.id = 'enable-sound-btn';
                            button.innerText = 'Enable Notification Sounds';
                            button.style.position = 'fixed';
                            button.style.top = '10px';
                            button.style.left = '50%';
                            button.style.transform = 'translateX(-50%)';
                            button.style.zIndex = '10000';
                            button.style.padding = '10px';
                            button.style.backgroundColor = 'var(--primary-color)';
                            button.style.color = 'white';
                            button.style.border = 'none';
                            button.style.borderRadius = '5px';
                            button.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                            button.onclick = function() {
                                sound.play().then(() => {
                                    console.log('Sound enabled by user interaction');
                                    button.remove();
                                }).catch(e => {
                                    console.error('Still cannot play sound:', e);
                                });
                            };
                            document.body.appendChild(button);
                        }
                    });
                }
            };
            
            // Try playing immediately
            forceInteraction();
            
            // Show browser notification for received messages when page is not in focus
            if (type === 'received' && document.visibilityState === 'hidden' && 
                typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                const friendName = document.getElementById('chat-with-name').textContent;
                new Notification(`New message from ${friendName}`, {
                    icon: document.getElementById('chat-with-avatar').src,
                    silent: true // We're already playing our own sound
                });
            }
        }
        
        // Helper functions for menu functionality
        function showNotification(message, color = '#4CAF50') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            
            if (newTheme === 'light') {
                document.documentElement.style.setProperty('--bg-primary', '#ffffff');
                document.documentElement.style.setProperty('--bg-secondary', '#f5f5f5');
                document.documentElement.style.setProperty('--bg-tertiary', '#e0e0e0');
                document.documentElement.style.setProperty('--text-primary', '#333333');
                document.documentElement.style.setProperty('--text-secondary', '#666666');
                showNotification('Light theme activated', '#FF9800');
            } else {
                document.documentElement.style.setProperty('--bg-primary', '#1e1e1e');
                document.documentElement.style.setProperty('--bg-secondary', '#2a2a2a');
                document.documentElement.style.setProperty('--bg-tertiary', '#3a3a3a');
                document.documentElement.style.setProperty('--text-primary', '#ffffff');
                document.documentElement.style.setProperty('--text-secondary', '#cccccc');
                showNotification('Dark theme activated', '#673AB7');
            }
        }
        
        function showAboutModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--bg-primary);
                padding: 30px;
                border-radius: 12px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                color: var(--text-primary);
            `;
            
            modalContent.innerHTML = `
                <h2 style="margin-bottom: 20px; color: var(--primary-color);">
                    <i class="fab fa-weixin"></i> WeChat Clone
                </h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Version 1.0.0
                </p>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    A modern messaging application built with HTML, CSS, and JavaScript. 
                    Features include real-time messaging, group chats, file sharing, and more.
                </p>
                <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 12px;">
                    © 2025 WeChat Clone. All rights reserved.
                </p>
                <button id="close-about" style="
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 500;
                ">Close</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal functionality
            document.getElementById('close-about').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
    
    <!-- Audio Call Interface -->
    <div id="audio-call-overlay" class="call-overlay">
        <div class="call-header">
            <div class="call-title">Audio Call</div>
            <div class="call-friend-name">Friend Name</div>
            <div class="call-status">Calling...</div>
            <div class="call-timer">00:00</div>
        </div>
        
        <div class="call-status-icon">
            <i class="fas fa-phone"></i>
        </div>
        
        <img src="" alt="Friend Avatar" class="call-avatar">
        
        <div class="call-actions">
            <div class="call-action toggle-mic" onclick="toggleMic()">
                <i class="fas fa-microphone"></i>
            </div>
            <div class="call-action end-call" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </div>
            <div class="call-action toggle-speaker">
                <i class="fas fa-volume-up"></i>
            </div>
        </div>
    </div>
    
    <!-- Audio Elements for Notifications -->
    <audio id="message-sent-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" type="audio/mpeg">
        <source src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="message-received-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/1713/1713-preview.mp3" type="audio/mpeg">
        <source src="https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Call Ringtone Sound -->
    <audio id="call-ringtone-sound" preload="auto" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Group Creation Modal -->
    <div id="group-modal" class="group-modal" style="display: none;">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <div class="group-modal-title">Create New Group</div>
                <button class="group-modal-close" id="group-modal-close">&times;</button>
            </div>
            <div class="group-modal-body">
                <div class="group-form-field">
                    <label class="group-form-label">Group Name</label>
                    <input type="text" class="group-form-input" id="group-name-input" placeholder="Enter group name">
                </div>
                
                <div class="group-form-field">
                    <label class="group-form-label">Group Members</label>
                    <div class="group-members" id="selected-members">
                        <!-- Selected members will appear here -->
                    </div>
                </div>
                
                <div class="add-members">
                    <label class="group-form-label">Add Members</label>
                    <select class="contact-select" id="contact-select">
                        <!-- Contact options will be added dynamically -->
                    </select>
                    <button class="add-member-btn" id="add-member-btn">Add</button>
                </div>
                
                <div class="group-form-actions">
                    <button class="group-form-btn cancel" id="cancel-group-btn">Cancel</button>
                    <button class="group-form-btn create" id="create-group-btn-submit">Create Group</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Group Info Modal -->
    <div id="group-info-modal" class="group-modal" style="display: none;">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <div class="group-modal-title">Group Information</div>
                <button class="group-modal-close" id="group-info-modal-close">&times;</button>
            </div>
            <div class="group-modal-body">
                <div class="group-form-field">
                    <label class="group-form-label">Group Name</label>
                    <input type="text" class="group-form-input" id="group-info-name" readonly>
                </div>
                
                <div class="group-form-field">
                    <label class="group-form-label">Created By</label>
                    <input type="text" class="group-form-input" id="group-info-created-by" readonly>
                </div>
                
                <div class="group-form-field">
                    <label class="group-form-label">Group Members</label>
                    <div class="group-members-list" id="group-members-list">
                        <!-- Group members will appear here -->
                    </div>
                </div>
                
                <div class="add-members">
                    <label class="group-form-label">Add New Members</label>
                    <select class="contact-select" id="group-info-contact-select">
                        <!-- Contact options will be added dynamically -->
                    </select>
                    <button class="add-member-btn" id="group-info-add-member-btn">Add</button>
                </div>
                
                <div class="group-form-actions">
                    <button class="group-form-btn cancel" id="leave-group-btn">Leave Group</button>
                    <button class="group-form-btn create" id="close-group-info-btn">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Call Interface -->
    <div id="video-call-overlay" class="call-overlay">
        <div class="call-header">
            <div class="call-title">Video Call</div>
            <div class="call-friend-name">Friend Name</div>
            <div class="call-status">Calling...</div>
            <div class="call-timer">00:00</div>
        </div>
        
        <div class="video-container">
            <img src="" alt="Friend Video" class="call-avatar">
            <div class="self-video">
                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face" alt="Your Video">
            </div>
        </div>
        
        <div class="call-actions">
            <div class="call-action toggle-mic" onclick="toggleMic()">
                <i class="fas fa-microphone"></i>
            </div>
            <div class="call-action toggle-camera" onclick="toggleCamera()">
                <i class="fas fa-video"></i>
            </div>
            <div class="call-action end-call" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </div>
        </div>
    </div>
    
    <!-- Create Group Modal -->
    <div id="create-group-modal" class="group-modal" style="display: none;">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <div class="group-modal-title">Create New Group</div>
                <button class="group-modal-close" id="close-group-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="group-modal-body">
                <div class="group-form-field">
                    <label class="group-form-label">Group Name</label>
                    <input type="text" class="group-form-input" id="group-name-input" placeholder="Enter group name">
                </div>
                
                <div class="group-form-field">
                    <label class="group-form-label">Group Description (Optional)</label>
                    <input type="text" class="group-form-input" id="group-description-input" placeholder="Enter group description">
                </div>
                
                <div class="group-members">
                    <label class="group-form-label">Group Members</label>
                    <div id="selected-members"></div>
                </div>
                
                <div class="add-members">
                    <select class="contact-select" id="contact-select">
                        <option value="">Select a contact to add</option>
                    </select>
                    <button class="add-member-btn" id="add-member-btn">Add to Group</button>
                </div>
                
                <div class="group-form-actions">
                    <button class="group-form-btn cancel" id="cancel-group-btn">Cancel</button>
                    <button class="group-form-btn create" id="create-group-btn-submit">Create Group</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Group Info Modal -->
    <div id="group-info-modal" class="group-modal" style="display: none;">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <div class="group-modal-title" id="group-info-title">Group Information</div>
                <button class="group-modal-close" id="close-group-info-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="group-modal-body">
                <div class="group-form-field">
                    <label class="group-form-label">Group Name</label>
                    <input type="text" class="group-form-input" id="group-info-name" placeholder="Enter group name" disabled>
                </div>
                
                <div class="group-form-field">
                    <label class="group-form-label">Group Description</label>
                    <input type="text" class="group-form-input" id="group-info-description" placeholder="No description" disabled>
                </div>
                
                <div class="group-members">
                    <label class="group-form-label">Group Members</label>
                    <div id="group-info-members" class="group-members-list"></div>
                </div>
                
                <div class="add-members" id="add-members-section">
                    <label class="group-form-label">Add New Member</label>
                    <select class="contact-select" id="group-contact-select">
                        <option value="">Select a contact to add</option>
                    </select>
                    <button class="add-member-btn" id="group-add-member-btn">Add to Group</button>
                </div>
                
                <div class="group-form-actions">
                    <button class="group-form-btn cancel" id="leave-group-btn">Leave Group</button>
                    <button class="group-form-btn create" id="save-group-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
